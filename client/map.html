<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Xorien's Lair - Map Display</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="pack/sha.js"></script>
        <script src="pack/crc.js"></script>
        <script src="scripts/cookies.js"></script>
        <script
            src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
            integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
            crossorigin="anonymous"></script>
        <script>
            function command(command, data, port, callback) {
                var sendData = {
                    "command":command,
                    "kwargs":data
                };
                $.post(
                    'http://' + self.location.hostname + ':' + port.toString(),
                    sendData,
                    callback,
                    'json'
                );
            }
        </script>
        <script>
            if (getCookie('uid') == '') {
                setCookie('uid',sha256(Math.random().toString()),14);
            }

            var BrowserFingerprint = getCookie('uid'); // Maintaining client session info with cookies
            var params = new URLSearchParams(document.location.search.substring(1)); // Get session id
            var previousData = {'null':null}; // Setup for data access
            var uType = 'pc'; // User type
            var cursor = 'default'; // Cursor type
            var obscureInfo = {
                obscuring:false,
                id:null,
                sx:null,
                sy:null,
                w:null,
                h:null,
                pageXS:null,
                pageYS:null
            }; // Obscure info maintain

            function limit(v,_min,_max) { // limit v to min & max
                if (v < _min) {
                    return _min;
                } else if (v > _max) {
                    return _max;
                } else {
                    return v
                }
            }

            function scmd(cmd,args,callback) {
                command('scmd',{
                    'sid':params.get('id'),
                    'fingerprint':BrowserFingerprint,
                    'command':cmd,
                    'args':args.join('|')
                },1023,callback);
            }

            var iconIndex = {
                'Artificer':'Artificer.png',
                'Barbarian':'Barbarian.png',
                'Bard':'Bard.png',
                'Cleric':'Cleric.png',
                'Druid':'Druid.png',
                'Fighter':'Fighter.png',
                'Monk':'Monk.png',
                'Mystic':'Mystic.png',
                'Paladin':'Paladin.png',
                'Ranger':'Ranger.png',
                'Rogue':'Rogue.png',
                'Sorcerer':'Sorcerer.png',
                'Warlock':'Warlock.png',
                'Wizard':'Wizard.png',
                'Dice':'Unknown.png',
                'Dragon':'Dragon.png',
                'Treasure':'Treasure.png'
            };

            var sizes = {
                'Tiny':2.5,
                'Small':5,
                'Medium':5,
                'Large':10,
                'Huge':15,
                'Gargantuan':20
            };

            var localMapData = {};

            function doMapImageClick(event) {
                var e = event.target;
                if ($(e).hasClass('selected')) {
                    $(e).toggleClass('selected',false);
                } else {
                    $('#maps-area img').toggleClass('selected',false);
                    $(e).toggleClass('selected',true);
                }

                if ($('#maps-area img').hasClass('selected')) {
                    $('#map-actions').toggleClass('active',true);
                } else {
                    $('#map-actions').toggleClass('active',false);
                }
            }

            function convertMouseToMapPos(id,x,y) {
                var el = document.getElementById(id);
                var data = JSON.parse(el.getAttribute('data'));
                var rect = el.getBoundingClientRect();
                return [(x-rect.left)/el.getAttribute('zoom'),(y-rect.top)/el.getAttribute('zoom')];
            }

            function saveAs(uri, filename) { // Code from https://stackoverflow.com/a/25715985
                var link = document.createElement('a');
                if (typeof link.download === 'string') {
                    link.href = uri;
                    link.download = filename;

                    //Firefox requires the link to be in the body
                    document.body.appendChild(link);
                    
                    //simulate click
                    link.click();

                    //remove the link when done
                    document.body.removeChild(link);
                } else {
                    window.open(uri);
                }
                }

            function refresh(data,override) { // Run this routine every .4s
                if (data == undefined) {
                    data = {'code':200};
                }
                if ((JSON.stringify(data) != JSON.stringify(previousData) && data.code == 200)) {
                    if (Object.keys(data).length <= 1) {
                        data = previousData;
                    }
                    previousData = data;

                    // Update player listing
                    var elbox = document.getElementById('user-area');
                    elbox.innerHTML = '';

                    var keys = Object.keys(previousData.users);

                    for (var k=0;k<keys.length;k++) {
                        var newElement = document.createElement('div');
                        newElement.id = 'user-'+previousData.users[keys[k]].fingerprint;
                        newElement.innerText = previousData.users[keys[k]].name;
                        newElement.className = 'noselect'
                        if (previousData.users[keys[k]].type == 'dm') {
                            newElement.style = 'border-left: 4px solid rgb(255, 47, 10);';
                        }
                        elbox.appendChild(newElement);
                    }

                    if (previousData.users[BrowserFingerprint].type == 'dm') {
                        uType = 'dm';
                        $('#player-buttons').css('display','none');
                        $('#dm-buttons').css('display','block');
                    } else {
                        uType = 'pc';
                        $('#dm-buttons').css('display','none');
                        $('#player-buttons').css('display','block');
                    }
                    $('#session-name').text('Session Name: '+previousData.name);

                    var mapArea = document.getElementById('maps-area');
                    mapArea.innerHTML = '';
                    var displayArea = document.getElementById('display-area');
                    displayArea.innerHTML = '';
                    for (var m=0;m<previousData.session.maps.length;m++) {
                        var el = document.createElement('img');
                        el.src = previousData.session.maps[m].image;
                        el.title = 'Dimensions: '.concat(
                            previousData.session.maps[m].grid_data.rows.toString(),
                            ' x ',
                            previousData.session.maps[m].grid_data.columns.toString(),
                            ' | Grid Size: ',
                            previousData.session.maps[m].grid_data.size.toString(),
                            ' ft.'
                        );
                        el.id = previousData.session.maps[m].id;
                        if (!Object.keys(localMapData).includes(el.id)) {
                            localMapData[el.id] = {
                                'zoom':1.0,
                                'pos':[0,0]
                            };
                        }
                        el.setAttribute('data',JSON.stringify(previousData.session.maps[m]));
                        el.onclick = doMapImageClick;
                        mapArea.appendChild(el);

                        if (previousData.session.maps[m].active == 'true') {
                            var container = document.createElement('div');
                            
                            container.className = 'map-container noselect';
                            container.id = previousData.session.maps[m].id;
                            $(container).css({
                                'width':(50*Number(previousData.session.maps[m].grid_data.columns*localMapData[container.id].zoom)).toString()+'px',
                                'height':(50*Number(previousData.session.maps[m].grid_data.rows*localMapData[container.id].zoom)).toString()+'px',
                                'top':localMapData[container.id].pos[1].toString() + 'px',
                                'left':localMapData[container.id].pos[0].toString() + 'px',
                                'cursor':cursor
                            });

                            // Obscure functions
                            $(container).mousedown(function(event){ // Start obscuring
                                if (cursor != 'crosshair') {
                                    return;
                                }
                                var target = event.delegateTarget;
                                if (event.target.className == 'obscure') {
                                    return;
                                }
                                
                                obscureInfo.id = target.id;
                                var pos = convertMouseToMapPos(target.id,event.pageX,event.pageY);
                                obscureInfo.sx = pos[0];
                                obscureInfo.sy = pos[1];
                                obscureInfo.pageXS = event.pageX;
                                obscureInfo.pageYS = event.pageY;
                                obscureInfo.obscuring = true;
                                $('#selection-box').css({
                                    top:'0px',
                                    left:'0px',
                                    width:'0px',
                                    height:'0px'
                                });
                                $('#selection-box').css('display','inline-block');
                            });
                            $(container).mousemove(function(event){ // Show obscure selection
                                var target = event.delegateTarget;
                                if (obscureInfo.obscuring && obscureInfo.id == target.id) {
                                    if (event.pageX >= obscureInfo.pageXS) {
                                        var left = obscureInfo.pageXS;
                                        var width = event.pageX - left;
                                    } else {
                                        var left = event.pageX;
                                        var width = obscureInfo.pageXS - left;
                                    }

                                    if (event.pageY >= obscureInfo.pageYS) {
                                        var top = obscureInfo.pageYS;
                                        var height = event.pageY - top;
                                    } else {
                                        var top = event.pageY;
                                        var height = obscureInfo.pageYS - top;
                                    }

                                    $('#selection-box').css({
                                        top:top.toString()+'px',
                                        left:left.toString()+'px',
                                        width:width.toString()+'px',
                                        height:height.toString()+'px'
                                    });
                                }
                            });
                            $(container).mouseup(function(event){ // Obscure finish
                                if (cursor != 'crosshair') {
                                    return;
                                }
                                var target = event.delegateTarget;
                                var data = JSON.parse($(target).attr('data'));
                                if (obscureInfo.obscuring && obscureInfo.id == target.id) {
                                    var newpos = convertMouseToMapPos(target.id,event.pageX,event.pageY);
                                    if (newpos[0] >= obscureInfo.sx) {
                                        obscureInfo.w = newpos[0]-obscureInfo.sx;
                                    } else {
                                        obscureInfo.w = obscureInfo.sx-newpos[0];
                                        obscureInfo.sx = newpos[0];
                                    }
                                    
                                    if (newpos[1] >= obscureInfo.sy) {
                                        obscureInfo.h = newpos[1]-obscureInfo.sy;
                                    } else {
                                        obscureInfo.h = obscureInfo.sy-newpos[1];
                                        obscureInfo.sy = newpos[1];
                                    }
                                    obscureInfo.obscuring = false;

                                    var args = [
                                        target.id,
                                        (obscureInfo.sx/(Number(data.grid_data.columns)*50))*100,
                                        (obscureInfo.sy/(Number(data.grid_data.rows)*50))*100,
                                        (obscureInfo.w/(Number(data.grid_data.columns)*50))*100,
                                        (obscureInfo.h/(Number(data.grid_data.rows)*50))*100,
                                        sha256(Math.random().toString())
                                    ];
                                    console.log(args);

                                    scmd('obscure',args,function(){$('#selection-box').css('display','none')});
                                    
                                }
                            });


                            container.setAttribute('zoom',localMapData[container.id].zoom.toString());
                            container.setAttribute('data',JSON.stringify(previousData.session.maps[m]));
                            var localContainer = document.createElement('div');
                            $(localContainer).css('position','relative');
                            localContainer.className = 'map-local';
                            var mapImage = document.createElement('img');
                            mapImage.src = previousData.session.maps[m].image;
                            $(mapImage).css({
                                'width':'100%',
                                'height':'100%'
                            });
                            mapImage.setAttribute('draggable',false);

                            localContainer.appendChild(mapImage);

                            for (var o=0;o<Object.keys(previousData.session.maps[m].obscuration).length;o++) {
                                var oid = Object.keys(previousData.session.maps[m].obscuration)[o];
                                var info = previousData.session.maps[m].obscuration[oid];

                                var obElement = document.createElement('div');
                                obElement.className = 'obscure';
                                obElement.setAttribute('mapid',container.id);
                                $(obElement).css({
                                    'left':info[0].toString()+'%',
                                    'top':info[1].toString()+'%',
                                    'width':(info[2]).toString()+'%',
                                    'height':(info[3]).toString()+'%',
                                    'background-color':'rgb(0,0,0)',
                                    'position':'absolute'
                                });
                                obElement.id = oid;
                                $(obElement).click(function(event){
                                    if (cursor =='crosshair') {
                                        scmd('remove_obscure',[event.delegateTarget.getAttribute('mapid'),event.delegateTarget.id],refresh);
                                    }
                                });
                                localContainer.appendChild(obElement);
                            }

                            

                            // Drag & Drop code from JQuery UI
                            container.appendChild(localContainer);
                            if (cursor == 'move') {
                                $(container).draggable({
                                    'disabled':false
                                });
                            } else {
                                $(container).draggable({
                                    'disabled':true
                                });
                            }
                            $(container).on('dragstop',function(event){
                                var rect = event.target.getBoundingClientRect();
                                var position = [
                                    Math.round(rect.left-(window.innerWidth*0.05)).toString(), 
                                    Math.round(rect.top-(window.innerHeight*0.05)).toString()
                                ];
                                $(container).css({
                                    'top':position[1]+'px',
                                    'left':position[0]+'px'
                                });
                                localMapData[container.id].pos = position;
                            });

                            displayArea.appendChild(container);
                        }
                    }
                }
            }

            $(document).ready(function(){
                // Page setup
                $('#share-link').text(document.location); // Set the share link
                
                var iconKeys = Object.keys(iconIndex); // Place icons in the icons bar
                for (var i=0;i<iconKeys.length;i++) {
                    var nel = document.createElement('div');
                    var iel = document.createElement('img');
                    iel.src = 'assets/icons/'+iconIndex[iconKeys[i]];
                    nel.appendChild(iel);
                    nel.title = iconKeys[i];
                    document.getElementById('icon-area').appendChild(nel);
                }
                

                // Fingerprint setup
                
                setTimeout(function () { // Ready fingerprint generation
                    console.log('FINGERPRINT: '+BrowserFingerprint);
                    command('checkuser',{'fingerprint':BrowserFingerprint},1023,function(data){
                        if (!data['found']) {
                            command('gsi',{'sid':params.get('id')},1023,function(data){
                                if (data['code'] == 200) {
                                    if (data['hasPassword']) {
                                        command('joinsession',{
                                            'name':prompt('Enter the name you want to display.'),
                                            'id':params.get('id'),
                                            'password':prompt('Enter password to join '+data['name']+'.'),
                                            'fingerprint':BrowserFingerprint
                                        },1023,function(data){
                                            if (Object.keys(data).includes('code')) {
                                                if (data['code'] == 403) {
                                                    alert('Password is incorrect.');
                                                    window.location = 'index.html';
                                                } else {
                                                    alert('That server does not exist. Please make sure you copied your join link correctly.')
                                                }
                                            } else {
                                                alert('Success!');
                                            }
                                        });
                                    } else {
                                        command('joinsession',{
                                            'name':prompt('Enter the name you want to display.'),
                                            'id':params.get('id'),
                                            'password':'',
                                            'fingerprint':BrowserFingerprint
                                        },1023,function(data){
                                            if (Object.keys(data).includes('code')) {
                                                if (data['code'] == 403) {
                                                    alert('Password is incorrect.');
                                                    window.location = 'index.html';
                                                } else {
                                                    alert('That server does not exist. Please make sure you copied your join link correctly.')
                                                }
                                            } else {
                                                alert('Success!');
                                            }
                                        });
                                    }
                                } else {
                                    alert('Cannot find that session.');
                                }
                            });
                        } else {
                            console.log(data);
                        }
                    });
                }, 2000);
                
                // Context menu manager
                window.addEventListener("contextmenu", e => {
                    if (event.target.id == 'display-area') {
                        e.preventDefault();
                        $('#custom-context').css({
                            'top':e.pageY,
                            'left':e.pageX
                        });
                        $('#custom-context').toggleClass('active',true);
                    }
                });
                window.addEventListener("click", e => {
                    $('#custom-context').toggleClass('active',false);
                });

                // Button functions
                $('#save-session').click(function(){ // Save the current session to a file
                    command('scmd',{
                        'sid':params.get('id'),
                        'fingerprint':BrowserFingerprint,
                        'command':'save',
                        'args':0
                    },1023,function(data){
                        var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data['save']));
                        saveAs(dataStr,'session.json');
                    });
                });

                $('#share-link').click(function() { // Copying the share link
                    var id = 'share-link';
                    var el = document.getElementById(id);
                    var range = document.createRange();
                    range.selectNodeContents(el);
                    var sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                    document.execCommand('copy');
                    $(this).attr('data-tooltip','Copied!');
                    window.setTimeout(function(){$('#share-link').attr('data-tooltip','Click to Copy')},2000);
                });

                $('#submit-nick').click(function(){ // Change player nickname
                    if ($('#change-nick-input').val() == '') {
                        $('#change-nick-input').toggleClass('invalid',true);
                        return;
                    } else {
                        $('#change-nick-input').toggleClass('invalid',false);
                    }
                    $('.active').toggleClass('active',false);
                    $('.invalid').toggleClass('invalid',false);
                    command('editname',{
                        'sid':params.get('id'),
                        'fingerprint':BrowserFingerprint,
                        'name':$('#change-nick-input').val()
                    },1023,function(data){
                        if (data['code'] == 404) {
                            alert('Error: '+data['reason']);
                        }
                    });
                });

                $('#btn-inc-size').click(function(){ // Increase icon size category
                    var keys = Object.keys(sizes);
                    if ($('#size-indicator').attr('name') != 'Gargantuan') {
                        var nextSize = keys[keys.indexOf($('#size-indicator').attr('name'))+1];
                        $('#size-indicator').attr('name',nextSize);
                        if (nextSize.length > 6) {
                            $('#size-indicator').text(nextSize.substring(0,5)+'.');
                        } else {
                            $('#size-indicator').text(nextSize);
                        }
                    }
                });
                $('#btn-dec-size').click(function(){ // Decrease icon size category
                    var keys = Object.keys(sizes);
                    if ($('#size-indicator').attr('name') != 'Tiny') {
                        var nextSize = keys[keys.indexOf($('#size-indicator').attr('name'))-1];
                        $('#size-indicator').attr('name',nextSize);
                        if (nextSize.length > 6) {
                            $('#size-indicator').text(nextSize.substring(0,5)+'.');
                        } else {
                            $('#size-indicator').text(nextSize);
                        }
                    }
                });

                $('#settings-submit').click(function(){ // Finish modifying settings
                    if ($('#session-name-set').val() == '') {
                        $('#session-name-set').toggleClass('invalid',true);
                        return;
                    } else {
                        $('#session-name-set').toggleClass('invalid',false);
                    }
                    $('.active').toggleClass('active',false);
                    $('.invalid').toggleClass('invalid',false);
                    command('modsession',{
                        'sid':params.get('id'),
                        'fingerprint':BrowserFingerprint,
                        'newname':$('#session-name-set').val(),
                        'newpass':$('#session-psw-set').val()
                    },1023,function(data){
                        if (data.code != 200) {
                            alert(data.reason);
                        }
                    });
                });
                $('#session-reset').click(function(){ // Purge all session info (maps & characters)
                    if (confirm('Are you sure? This action is irreversible unless you have saved a copy of this session.')) {
                        command('purge',{
                            'sid':params.get('id'),
                            'fingerprint':BrowserFingerprint
                        },1023,function(data){
                            if (data.code != 200) {
                                alert(data.reason);
                            }
                        })
                    }
                });

                $('#set-sheet-input').keyup(function(){ // Update iframe to display sheet.
                    $('#sheet-frame').attr('src',$('#set-sheet-input').val());
                    if ($('#set-sheet-input').val().includes('spreadsheets')) {
                        $('#sheet-frame').show(0);
                    } else {
                        $('#sheet-frame').hide(0);
                    }
                });
                $('#submit-sheet').click(function(){ // Submit sheet
                    if ($('#set-sheet-input').val() == '') {
                        $('#set-sheet-input').toggleClass('invalid',true);
                        return;
                    } else {
                        $('#set-sheet-input').toggleClass('invalid',false);
                    }
                    $('.active').toggleClass('active',false);
                    $('.invalid').toggleClass('invalid',false);
                    command('scmd',{
                        'sid':params.get('id'),
                        'fingerprint':BrowserFingerprint,
                        'command':'load_sheet',
                        'args':$('#set-sheet-input').val()
                    },1023,function(data){
                        if (data['code'] == 200) {
                            alert('Sheet loaded.');
                        } else {
                            alert('Error: '+data['reason']);
                        }
                    });
                });

                // Loading maps
                $('#load-map').click(function(){$('#load-map-file').click()});
                $('#load-map-file').change(function(){
                    var file = document.getElementById('load-map-file').files[0];
                    var reader = new FileReader();
                    reader.addEventListener("load", function () {
                        if ($('#map-rows').val() == '') {
                            var rows = 20;
                        } else {
                            var rows = $('#map-rows').val();
                        }
                        if ($('#map-cols').val() == '') {
                            var cols = 20;
                        } else {
                            var cols = $('#map-cols').val();
                        }
                        if ($('#grid-size-inp').val() == '') {
                            var gs = 5;
                        } else {
                            var gs = $('#grid-size-inp').val();
                        }

                        scmd('load_map',[reader.result,rows,cols,gs],refresh);
                    }, false);
                
                    if (file) {
                        reader.readAsDataURL(file);
                    }
                });

                // Map Buttons
                $('#remove-map').click(function(){
                    scmd('delete_map',[$('#maps-area .selected').attr('id')],refresh);
                    $('#map-actions').toggleClass('active',false);
                });
                $('#place-map').click(function(){
                    var mapData = JSON.parse($('#maps-area .selected').attr('data'));
                    scmd('modify_map',[
                    $('#maps-area .selected').attr('id'),
                    mapData.grid_data.rows,
                    mapData.grid_data.columns,
                    mapData.grid_data.size,true
                    ],refresh);
                    $('#map-actions').toggleClass('active',false);
                });
                $('#mod-map').click(function(){
                    var mapData = JSON.parse($('#maps-area .selected').attr('data'));

                    if ($('#map-rows').val() == '') {
                        var rows = mapData.grid_data.rows;
                    } else {
                        var rows = $('#map-rows').val();
                    }
                    if ($('#map-cols').val() == '') {
                        var cols = mapData.grid_data.columns;
                    } else {
                        var cols = $('#map-cols').val();
                    }
                    if ($('#grid-size-inp').val() == '') {
                        var gs = mapData.grid_data.size;
                    } else {
                        var gs = $('#grid-size-inp').val();
                    }

                    scmd('modify_map',[
                    $('#maps-area .selected').attr('id'),
                    rows,
                    cols,
                    gs,
                    mapData.active
                    ],refresh);
                    $('#map-actions').toggleClass('active',false);
                });

                $('#cursors-bar button').click(function(event){
                    cursor = event.delegateTarget.getAttribute('name');
                    
                    console.log(event.delegateTarget);
                    console.log(cursor);
                    refresh();
                });

                // Zooming
                $('#display-area').on('wheel',function(event){
                    var topContainer = event.target.parentElement.parentElement;
                    if (topContainer.classList.contains('map-container')) {
                        var Dy = event.originalEvent.deltaY;
                        var zoomMod = Number(topContainer.getAttribute('zoom'));
                        if (Dy < 0) {
                            zoomMod += 0.05;
                        } else if (Dy > 0) {
                            zoomMod -= 0.05;
                        }
                        topContainer.setAttribute('zoom',limit(zoomMod,0.1,2).toString());
                        localMapData[topContainer.id].zoom = limit(zoomMod,0.1,5);
                        var dispArea = document.getElementById('display-area');

                        var dx = ((event.pageX-dispArea.clientLeft) - topContainer.clientLeft) * (zoomMod-1);
                            dy = ((event.pageY-dispArea.clientTop) - topContainer.clientTop) * (zoomMod-1);
                        localMapData[topContainer.id].pos = [topContainer.clientLeft - dx,topContainer.clientTop - dy];
                        var cid = null;
                        for (var i=0;i<previousData.session.maps.length;i++) {
                            if (previousData.session.maps[i].id==topContainer.id) {
                                cid = i;
                            }
                        }

                        $(topContainer).css({
                            'width':(50*Number(previousData.session.maps[cid].grid_data.columns*localMapData[topContainer.id].zoom)).toString()+'px',
                            'height':(50*Number(previousData.session.maps[cid].grid_data.rows*localMapData[topContainer.id].zoom)).toString()+'px',
                            'top':localMapData[topContainer.id].pos[1].toString() + 'px',
                            'left':localMapData[topContainer.id].pos[0].toString() + 'px',
                            'cursor':cursor
                        });
                        refresh();
                    }
                });

                // Refresh Loop
                window.setInterval(function(){
                    command('gsi',{'sid':params.get('id')},1023,refresh);
                },400);

                // Button Cosmetics
                $('#modal-back').click(function(){$('.active').toggleClass('active',false);$('.invalid').toggleClass('invalid',false);});
                $('#edit-name').click(function(){
                    $('#modal-back').toggleClass('active',true);
                    $('#change-name-dialog').toggleClass('active',true);
                });
                $('#set-sheet').click(function(){
                    $('#modal-back').toggleClass('active',true);
                    $('#set-sheet-dialog').toggleClass('active',true);
                    $('#set-sheet-input').val('');
                    $('#sheet-frame').hide(0);
                });
                $('#settings').click(function(){
                    $('#modal-back').toggleClass('active',true);
                    $('#session-name-set').val(previousData.name);
                    $('#settings-menu').toggleClass('active',true);
                });
                $('#manage-maps').click(function(){
                    $('#modal-back').toggleClass('active',true);
                    $('#manage-maps-menu').toggleClass('active',true);
                    $('#maps-area img').toggleClass('selected',false);
                    refresh();
                });
            });
            
        </script>

        <link rel="stylesheet" type="text/css" href="style/common.css">
        <link rel="stylesheet" type="text/css" href="style/tooltips.css">
        <link rel="stylesheet" type="text/css" href="style/map.css">
    </head>
    <body>
        <div id="modal-back"></div>
        <iframe id="downloader" style="display:none;"></iframe>
        <div id='custom-context'>
        </div>

        <div id='cursors-bar'>
            <button id='set-cursor-normal' name='default'><img src="assets/cursor.png"><div>Select</div></button>
            <button id='set-cursor-move' name='move'><img src="assets/move.png"><div>Move</div></button>
            <button id='set-cursor-obscure' name='crosshair'><img src="assets/obscure.png"><div>Obscure</div></button>
        </div>

        <div id='top-bar'>
            <h3 id='session-name'>Session Name: NULL</h3>
            <h3>Share Link</h3>
            <div id='share-link' data-tooltip='Click to Copy' data-tooltip-location="bottom">NULL</div>
        </div>
        <div id='users-bar'>
            <div id='user-area'></div>
            <div class='user-buttons' id='player-buttons'>
                <button id='edit-name' data-tooltip='Edit Player Name' data-tooltip-location="right"><img src="assets/editname.png"></button>
                <button id='set-sheet' data-tooltip='Import Sheet' data-tooltip-location="right"><img src="assets/sheet.png"></button>
                <button id='set-icon' data-tooltip='Set Player Icon' data-tooltip-location="right"><img src="assets/avatar.png"></button>
            </div>
            <div class='user-buttons' id='dm-buttons'>
                <button id='save-session' data-tooltip='Save Session' data-tooltip-location="right"><img src="assets/save.png"></button>
                <button id='manage-maps' data-tooltip='Manage Maps' data-tooltip-location="right"><img src="assets/map.png"></button>
                <input id='load-map-file' style='display: none;' type="file">
                <button id='settings' data-tooltip='Settings' data-tooltip-location="right"><img src="assets/settings.png"></button>
            </div>
        </div>
        <div id='icons-bar' class='noscroll'>
            <div id='icon-area' class='noscroll'></div>
            <div id='icon-buttons'>
                <button id='btn-inc-size'>+</button>
                <p class='noselect' data-tooltip="Icon Size" data-tooltip-location="left" name='Medium' id='size-indicator'>Medium</p>
                <button id='btn-dec-size'>-</button>
            </div>
        </div>
        
        <div id='display-area'></div>

        <div id='icon-attribution' class='noscroll'>
            <img src='assets/uparrow.png' width="32px" height="32px">
            <p>Nickname Icon: <a href="https://www.flaticon.com/authors/bqlqn" title="bqlqn">bqlqn</a> from <a href="https://www.flaticon.com/" title="Flaticon"> www.flaticon.com</a></p>
            <p>Up Arrow Icon: <a href="https://www.flaticon.com/authors/roundicons" title="Roundicons">Roundicons</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>Sheet Icon: <a href="https://creativemarket.com/Becris" title="Becris">Becris</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>User Icon: <a href="http://www.freepik.com/" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>Class Icons: <a href="https://www.enworld.org/threads/class-icons.517189/" title="EN WORLD">EN WORLD</a></p>
            <p>Save Icon: <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>Map Icon: <a href="https://creativemarket.com/Becris" title="Becris">Becris</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>Settings Icon: <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>Dragon Icon: <a href="https://www.flaticon.com/authors/icongeek26" title="Icongeek26">Icongeek26</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>Treasure Chest Icon: <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>Trash Can Icon: <a href="https://www.flaticon.com/free-icon/delete_1214594" title="Kiranshastry">Kiranshastry</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>Place Map Icon: <a href="https://www.flaticon.com/authors/roundicons" title="Roundicons">Roundicons</a> from <a href="https://www.flaticon.com/" title="Flaticon"> www.flaticon.com</a></p>
            <p>Basic Cursor Icon: <a href="https://icon54.com/" title="Pixel perfect">Pixel perfect</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>Move Cursor Icon: <a href="https://www.flaticon.com/authors/roundicons" title="Roundicons">Roundicons</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>Obscuration Cursor Icon: <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
        </div>

        <!-- Dialogs -->
        <div id='change-name-dialog' class='dialog'>
            <p>Change nickname:</p>
            <input id='change-nick-input' placeholder="Nickname" size="30">
            <button id='submit-nick'>Change Nickname</button>
        </div>

        <div id='set-sheet-dialog' class='dialog'>
            <p>Enter sheet URL (GSheet2 or D&D Beyond):</p>
            <input id='set-sheet-input' placeholder="URL" size="30">
            <iframe src='null' id='sheet-frame'><p>Entered URL does not link to a sheet.</p></iframe>
            <button id='submit-sheet'>Set Sheet</button>
        </div>

        <!-- Large Dialogs -->
        <div id='settings-menu' class='large-dialog'>
            <h2>Settings</h2>
            <div class='block'>
                <h3>Set Session Name</h3>
                <input id='session-name-set' placeholder="Set Name" size="30">
            </div>
            <div class='block'>
                <h3>Set Session Password</h3>
                <input id='session-psw-set' placeholder="Set Password" size="30">
            </div>
            <div class='block'>
                <h3>Purge Session</h3>
                <button id='session-reset'>Purge</button>
            </div>
            <button class='submit-button' id='settings-submit'>Finish</button>
        </div>
        <div id='manage-maps-menu' class="large-dialog">
            <h2>Manage Maps</h2>
            <div class='action-btns' id='map-actions'>
                <button id='remove-map' data-tooltip="Remove Map"><img src="assets/delete.png"></button>
                <button id='place-map' data-tooltip="Place Map"><img src="assets/place.png"></button>
                <button id='mod-map' data-tooltip="Change Map Dimensions & Grid Size"><img src="assets/settings.png"></button>
            </div>
            <div class='inline-block' id='maps-area'></div>
            <div class='inline-block' id='map-options'>
                <h3 style="width: 20%;text-align:center;">Map Size</h3>
                <input style="width: 33%; text-align: center;" id="map-rows" type="number" placeholder="Rows" value='20'><span style="color: rgb(239, 243, 251);width:4%;font-family:roboto;text-align: center;"> X </span><input style="width: 33%; text-align: center;" id="map-cols" type="number" placeholder="Columns" value='20'>
                <h3 style="width: 20%;text-align:center;margin-top:2%;">Grid Size</h3>
                <input style="width: 73%; text-align: center;" type="number" id="grid-size-inp" placeholder="Grid Size (feet)" value='5'>
                <button style="width: 100%;margin-top: 2vh;" id='load-map'>Load New Map</button>
            </div>
        </div>
        <div id='selection-box'></div>
    </body>
</html>