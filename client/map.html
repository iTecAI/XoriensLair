<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Xorien's Lair - Map Display</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.4.0/bootbox.min.js"></script>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="pack/sha.js"></script>
        <script src="pack/crc.js"></script>
        <script src="scripts/cookies.js"></script>
        <script
            src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
            integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
            crossorigin="anonymous"></script>
        <script>
            function command(command, data, port, callback) {
                var sendData = {
                    "command":command,
                    "kwargs":data
                };
                $.post(
                    'http://' + self.location.hostname + ':' + port.toString(),
                    sendData,
                    callback,
                    'json'
                );
            }
        </script>
        <script>
            if (getCookie('uid') == '') {
                setCookie('uid',sha256(Math.random().toString()),14);
            }

            var BrowserFingerprint = getCookie('uid'); // Maintaining client session info with cookies
            var params = new URLSearchParams(document.location.search.substring(1)); // Get session id
            var previousData = {'null':null}; // Setup for data access
            var uType = 'pc'; // User type
            var cursor = 'default'; // Cursor type
            var obscureInfo = {
                obscuring:false,
                id:null,
                sx:null,
                sy:null,
                w:null,
                h:null,
                pageXS:null,
                pageYS:null
            }; // Obscure info maintain
            var currentInitiative = null;

            /*
                selection arguments:
                allowedUsers|ctxModifiers

                allowedUsers: (comma-sep)
                - pc: Player/User
                - dm: Dungeon Master

                ctxModifiers: (comma-sep)
                - self: User owns this character (pc only)
                - !self: User does not own this character and is not the DM
                - init: It is user's turn in initiative, or it is the turn in the initiative of one of the DM's NPCs
                - !init: It is NOT user's turn in initiative, or it is NOT the turn in the initiative of one of the DM's NPCs
                - in_init: The user's PC or the selected NPC is in the initiative count
                - !in_init: The user's PC or the selected NPC is NOT in the initiative count
            */
            var ctxMenu = { // Selectors to activate custom context menu on
                '#display-area':{
                    'end-initiative':'dm'
                },
                '.map-container':{
                    'map-close':'dm',
                    'add-pc':'pc',
                    'add-npc':'dm',
                    'end-initiative':'dm'
                },
                '.pc-icon':{
                    'remove-pc':'pc|self',
                    'remove-pc-dm':'dm',
                    'run-initiative':'pc|!in_init,self',
                    'remove-initiative':'pc|in_init,self',
                    'set-pc-hp':'pc,dm|self',
                    'set-pc-max-hp':'pc,dm|self',
                    'change-pc-hp':'pc,dm|self',
                    'edit-pc':'pc,dm|self',
                    'claim-pc':'pc|!self'
                },
                '.npc-icon':{
                    'remove-npc':'dm',
                    'run-initiative':'dm|!in_init',
                    'remove-initiative':'dm|in_init'
                }
            }; 

            var SCORES = [
                ['str','strength'],
                ['dex','dexterity'],
                ['con','constitution'],
                ['int','intelligence'],
                ['wis','wisdom'],
                ['cha','charisma']
            ];
            var SKILLS = [
                'athletics',
                'acrobatics','sleightOfHand','stealth',
                'arcana','history','investigation','nature','religion',
                'animalHandling','insight','medicine','perception','survival',
                'deception','intimidation','performance','persuasion'
            ];

            var currentCtx = null; // Currently active context menu

            var npcData = { // Data for making NPCs
                makingNPC:false,
                map:null,
                pos:[0,0],
                data:null,
                icon:null
            };

            function limit(v,_min,_max) { // limit v to min & max
                if (v < _min) {
                    return _min;
                } else if (v > _max) {
                    return _max;
                } else {
                    return v
                }
            }

            function getmod(score) {
                var modref = {
                    '1':-5,
                    '2-3':-4,
                    '4-5':-3,
                    '6-7':-2,
                    '8-9':-1,
                    '10-11':0,
                    '12-13':1,
                    '14-15':2,
                    '16-17':3,
                    '18-19':4,
                    '20-21':5,
                    '22-23':6,
                    '24-25':7,
                    '26-27':8,
                    '28-29':9,
                    '30':10
                }

                for (var k=0;k<Object.keys(modref).length;k++) {
                    if (Object.keys(modref)[k].split('-').includes(score.toString())) {
                        return modref[Object.keys(modref)[k]];
                    }
                }
                return null;
            }

            function roundTo(v,interval) { // Round v to nearest interval (ie round 54 to nearest 50 = 50, round 97 to nearest 50 = 100)
                return Math.round(v/interval)*interval;
            }

            // Code from https://stackoverflow.com/a/11183002
            var stringConstructor = "test".constructor;
            var arrayConstructor = [].constructor;
            var objectConstructor = ({}).constructor;
            var numberConstructor = Number(1).constructor;

            function whatIsIt(object) {
                if (object === null) {
                    return "null";
                }
                if (object === undefined) {
                    return "undefined";
                }
                if (object.constructor === stringConstructor) {
                    return "string";
                }
                if (object.constructor === numberConstructor) {
                    return "number";
                }
                if (object.constructor === arrayConstructor) {
                    return "array";
                }
                if (object.constructor === objectConstructor) {
                    return "object";
                }
                {
                    return null;
                }
            }
            // End stackoverflow code

            function toPythonListStr(l) {
                var output = '[';
                for (var i=0;i<l.length;i++) {
                    if (whatIsIt(l[i]) == "number") {
                        output += Number(l[i]) + ',';
                    } else if (whatIsIt(l[i]) == "array") {
                        output += toPythonListStr(l[i]) + ',';
                    } else if (whatIsIt(l[i]) == 'object') {
                        output += '"'+JSON.stringify(l[i]) + '",';
                    } else {
                        output += '"'+l[i].toString() + '",';
                    }
                }
                if (output.endsWith(',')) {
                    output = output.substr(0,output.length-1);
                }
                output += ']';
                return output;
            }

            function scmd(cmd,args,callback) {
                for (var a=0;a<args.length;a++) {
                    if (whatIsIt(args[a]) == "array") {
                        args[a] = toPythonListStr(args[a]);
                    }
                }
                console.log(args);
                command('scmd',{
                    'sid':params.get('id'),
                    'fingerprint':BrowserFingerprint,
                    'command':cmd,
                    'args':args.join('|')
                },1023,callback);
            }

            var iconIndex = {
                'Artificer':'Artificer.png',
                'Barbarian':'Barbarian.png',
                'Bard':'Bard.png',
                'Cleric':'Cleric.png',
                'Druid':'Druid.png',
                'Fighter':'Fighter.png',
                'Monk':'Monk.png',
                'Mystic':'Mystic.png',
                'Paladin':'Paladin.png',
                'Ranger':'Ranger.png',
                'Rogue':'Rogue.png',
                'Sorcerer':'Sorcerer.png',
                'Warlock':'Warlock.png',
                'Wizard':'Wizard.png',
                'Dice':'Unknown.png',
                'Dragon':'Dragon.png',
                'Treasure':'Treasure.png'
            };

            var sizes = {
                'Tiny':2.5,
                'Small':5,
                'Medium':5,
                'Large':10,
                'Huge':15,
                'Gargantuan':20
            };

            var localMapData = {};

            function getIcon(path) {
                if (Object.keys(iconIndex).includes(path)) {
                    console.log('assets/icons/'+iconIndex[path]);
                    return 'assets/icons/'+iconIndex[path];
                } else {
                    console.log(path)
                    return path;
                }
            }

            function doMapImageClick(event) {
                var e = event.target;
                if ($(e).hasClass('selected')) {
                    $(e).toggleClass('selected',false);
                } else {
                    $('#maps-area img').toggleClass('selected',false);
                    $(e).toggleClass('selected',true);
                }

                if ($('#maps-area img').hasClass('selected')) {
                    $('#map-actions').toggleClass('active',true);
                } else {
                    $('#map-actions').toggleClass('active',false);
                }
            }

            function convertMouseToMapPos(id,x,y) {
                var el = document.getElementById(id);
                var data = JSON.parse(el.getAttribute('data'));
                var rect = el.getBoundingClientRect();
                return [(x-rect.left)/el.getAttribute('zoom'),(y-rect.top)/el.getAttribute('zoom')];
            }

            function saveAs(uri, filename) { // Code from https://stackoverflow.com/a/25715985
                var link = document.createElement('a');
                if (typeof link.download === 'string') {
                    link.href = uri;
                    link.download = filename;

                    //Firefox requires the link to be in the body
                    document.body.appendChild(link);
                    
                    //simulate click
                    link.click();

                    //remove the link when done
                    document.body.removeChild(link);
                } else {
                    window.open(uri);
                }
                }

            function refresh(data,override) { // Run this routine every .4s
                if (data == undefined) {
                    data = {'code':200};
                }

                if ((JSON.stringify(data) != JSON.stringify(previousData) && data.code == 200)) {
                    if (Object.keys(data).length <= 1) {
                        data = previousData;
                    }
                    previousData = data;

                    if (data.session.initiative.active) {
                        $('#adv-init').show();
                        $('#adv-stop').show();
                        $('#initiative-box').show();
                    } else {
                        $('#adv-init').hide();
                        $('#adv-stop').hide();
                        $('#initiative-box').hide();
                        currentInitiative = null;
                    }

                    scmd(
                        'initiative',
                        ['check',$('#'+currentCtx).attr('mapId'),$('#'+currentCtx).attr('id')],
                        function(data){
                            $('#ci-img').attr('src',getIcon(data.current.icon));
                            $('#ni-img').attr('src',getIcon(data.next.icon));
                            $('#current-init').attr('data-tooltip',data.current.name);
                            $('#next-init').attr('data-tooltip',data.next.name);
                            
                        }
                    );

                    // Update player listing
                    var elbox = document.getElementById('user-area');
                    elbox.innerHTML = '';

                    var keys = Object.keys(previousData.users);

                    for (var k=0;k<keys.length;k++) {
                        if (previousData.users[keys[k]].active) {
                            var newElement = document.createElement('div');
                            newElement.id = 'user-'+previousData.users[keys[k]].fingerprint;
                            newElement.innerText = previousData.users[keys[k]].name;
                            newElement.className = 'noselect'
                            if (previousData.users[keys[k]].type == 'dm') {
                                newElement.style = 'border-left: 4px solid rgb(255, 47, 10);';
                            }
                            elbox.appendChild(newElement);
                        }
                    }

                    if (previousData.users[BrowserFingerprint].type == 'dm') {
                        uType = 'dm';
                        $('#player-buttons').css('display','none');
                        $('#dm-buttons').css('display','block');
                    } else {
                        uType = 'pc';
                        $('#dm-buttons').css('display','none');
                        $('#player-buttons').css('display','block');
                    }
                    $('#session-name').text('Session Name: '+previousData.name);

                    // Hide or show user-type specific elements
                    if (uType == 'dm') {
                        $('.player-only').hide();
                    } else {
                        $('.dm-only').hide();
                    }

                    var mapArea = document.getElementById('maps-area');
                    mapArea.innerHTML = '';
                    var displayArea = document.getElementById('display-area');
                    displayArea.innerHTML = '';
                    for (var m=0;m<previousData.session.maps.length;m++) {
                        var el = document.createElement('img');
                        el.src = previousData.session.maps[m].image;
                        el.title = 'Dimensions: '.concat(
                            previousData.session.maps[m].grid_data.rows.toString(),
                            ' x ',
                            previousData.session.maps[m].grid_data.columns.toString(),
                            ' | Grid Size: ',
                            previousData.session.maps[m].grid_data.size.toString(),
                            ' ft.'
                        );
                        el.id = previousData.session.maps[m].id;
                        if (!Object.keys(localMapData).includes(el.id)) {
                            localMapData[el.id] = {
                                'zoom':1.0,
                                'pos':[0,0]
                            };
                        }
                        el.setAttribute('data',JSON.stringify(previousData.session.maps[m]));
                        el.onclick = doMapImageClick;
                        mapArea.appendChild(el);

                        if (previousData.session.maps[m].active == 'true') {
                            var container = document.createElement('div');
                            
                            container.className = 'map-container noselect';
                            container.id = previousData.session.maps[m].id;
                            $(container).css({
                                'width':(50*Number(previousData.session.maps[m].grid_data.columns*localMapData[container.id].zoom)).toString()+'px',
                                'height':(50*Number(previousData.session.maps[m].grid_data.rows*localMapData[container.id].zoom)).toString()+'px',
                                'top':localMapData[container.id].pos[1].toString() + 'px',
                                'left':localMapData[container.id].pos[0].toString() + 'px',
                                'cursor':cursor
                            });

                            // Obscure functions
                            $(container).mousedown(function(event){ // Start obscuring
                                if (cursor != 'crosshair') {
                                    return;
                                }
                                var target = event.delegateTarget;
                                if (event.target.className == 'obscure') {
                                    return;
                                }
                                
                                obscureInfo.id = target.id;
                                var pos = convertMouseToMapPos(target.id,event.pageX,event.pageY);
                                obscureInfo.sx = pos[0];
                                obscureInfo.sy = pos[1];
                                obscureInfo.pageXS = event.pageX;
                                obscureInfo.pageYS = event.pageY;
                                obscureInfo.obscuring = true;
                                console.log(obscureInfo);
                                $('#selection-box').css({
                                    top:'0px',
                                    left:'0px',
                                    width:'0px',
                                    height:'0px'
                                });
                                $('#selection-box').css('display','inline-block');
                                
                            });
                            $(container).mousemove(function(event){ // Show obscure selection
                                var target = event.delegateTarget;
                                if (obscureInfo.obscuring && (obscureInfo.id == target.id || target.id == 'selection-box')) {
                                    if (event.pageX >= obscureInfo.pageXS) {
                                        var left = obscureInfo.pageXS;
                                        var width = event.pageX - left;
                                    } else {
                                        var left = event.pageX;
                                        var width = obscureInfo.pageXS - left;
                                    }

                                    if (event.pageY >= obscureInfo.pageYS) {
                                        var top = obscureInfo.pageYS;
                                        var height = event.pageY - top;
                                    } else {
                                        var top = event.pageY;
                                        var height = obscureInfo.pageYS - top;
                                    }

                                    $('#selection-box').css({
                                        top:(top-2).toString()+'px',
                                        left:(left-2).toString()+'px',
                                        width:width.toString()+'px',
                                        height:height.toString()+'px'
                                    });
                                }
                            });
                            $(container).mouseup(function(event){ // Obscure finish
                                if (cursor != 'crosshair') {
                                    return;
                                }
                                var target = event.delegateTarget;
                                var data = JSON.parse($(target).attr('data'));
                                if (obscureInfo.obscuring && (obscureInfo.id == target.id || target.id == 'selection-box')) {
                                    var newpos = convertMouseToMapPos(target.id,event.pageX,event.pageY);
                                    if (newpos[0] >= obscureInfo.sx) {
                                        obscureInfo.w = newpos[0]-obscureInfo.sx;
                                    } else {
                                        obscureInfo.w = obscureInfo.sx-newpos[0];
                                        obscureInfo.sx = newpos[0];
                                    }
                                    
                                    if (newpos[1] >= obscureInfo.sy) {
                                        obscureInfo.h = newpos[1]-obscureInfo.sy;
                                    } else {
                                        obscureInfo.h = obscureInfo.sy-newpos[1];
                                        obscureInfo.sy = newpos[1];
                                    }
                                    obscureInfo.obscuring = false;
                                    var zoomMod = Number(target.getAttribute('zoom'));
                                    console.log(obscureInfo.sx/(Number(data.grid_data.columns)*10)*20,obscureInfo.sy/(Number(data.grid_data.rows)*10)*20);
                                    var args = [
                                        target.id,
                                        Math.round((obscureInfo.sx/(Number(data.grid_data.columns)*10))*20)/5,
                                        Math.round((obscureInfo.sy/(Number(data.grid_data.rows)*10))*20)/5,
                                        (obscureInfo.w/(Number(data.grid_data.columns)*50))*100,
                                        (obscureInfo.h/(Number(data.grid_data.rows)*50))*100,
                                        sha256(Math.random().toString())
                                    ];
                                    console.log(args);
                                    if (args[3] < 1 && args[4] < 1) {
                                        return;
                                    }

                                    scmd('obscure',args,function(data){
                                        $('#selection-box').css('display','none');
                                    });
                                    
                                }
                            });

                            $('#display-area').mousemove(function(event){
                                if (obscureInfo.obscuring && event.target.id == 'display-area') {
                                    $('#selection-box').css('display','none');
                                    obscureInfo.obscuring = false;
                                }
                            });


                            container.setAttribute('zoom',localMapData[container.id].zoom.toString());
                            container.setAttribute('data',JSON.stringify(previousData.session.maps[m]));
                            var localContainer = document.createElement('div');
                            $(localContainer).css('position','relative');
                            localContainer.className = 'map-local';
                            var mapImage = document.createElement('img');
                            mapImage.src = previousData.session.maps[m].image;
                            $(mapImage).contextmenu(function(event){
                                event.preventDefault();
                                $(event.target.parentElement.parentElement).trigger('contextmenu',[event.pageX,event.pageY]);
                            });
                            $(mapImage).css({
                                'width':'100%',
                                'height':'100%'
                            });
                            mapImage.setAttribute('draggable',false);

                            localContainer.appendChild(mapImage);

                            // Draw obscuration rects

                            for (var o=0;o<Object.keys(previousData.session.maps[m].obscuration).length;o++) {
                                var oid = Object.keys(previousData.session.maps[m].obscuration)[o];
                                var info = previousData.session.maps[m].obscuration[oid];

                                var obElement = document.createElement('div');
                                obElement.className = 'obscure';
                                obElement.setAttribute('mapid',container.id);
                                $(obElement).css({
                                    'left':(info[0]*5).toString()+'%',
                                    'top':(info[1]*5).toString()+'%',
                                    'width':(info[2]).toString()+'%',
                                    'height':(info[3]).toString()+'%',
                                    'background-color':'rgb(0,0,0)',
                                    'position':'absolute',
                                    'z-index':'101'
                                });
                                obElement.id = oid;
                                $(obElement).click(function(event){
                                    if (cursor =='crosshair') {
                                        scmd('remove_obscure',[event.delegateTarget.getAttribute('mapid'),event.delegateTarget.id],refresh);
                                    }
                                });
                                localContainer.appendChild(obElement);
                            }

                            // Add active characters to the map
                            for (var c=0;c<Object.keys(previousData.session.maps[m].characters).length;c++) {
                                var key = Object.keys(previousData.session.maps[m].characters)[c];
                                var id = Object.keys(previousData.session.maps[m].characters)[c];
                                var name = previousData.session.maps[m].characters[key].name;
                                var position = previousData.session.maps[m].characters[key].pos;
                                var icon = previousData.session.maps[m].characters[key].icon;
                                var data = previousData.session.characters[key];
                                if (!icon.includes('data')) {
                                    icon = 'assets/icons/'+iconIndex[icon];
                                }

                                var pcElement = document.createElement('div');
                                pcElement.id = id;
                                pcElement.setAttribute('mapId',container.id);
                                pcElement.title = 'Name: '+name+' | HP: '+data.hp+'/'+data.max_hp+' | AC: '+data.ac;
                                pcElement.className = 'pc-icon';
                                var pcImg = document.createElement('img');
                                pcImg.src = icon;
                                $(pcImg).on('contextmenu',function(event){
                                    event.preventDefault();
                                    $(event.target.parentElement).trigger('contextmenu',[event.pageX,event.pageY]);
                                });
                                pcElement.appendChild(pcImg);
                                $(pcElement).css({
                                    top:((Number(position[1])/Number(previousData.session.maps[m].grid_data['rows']))*100).toString()+'%',
                                    left:((Number(position[0])/Number(previousData.session.maps[m].grid_data['columns']))*100).toString()+'%',
                                    width:(((5/Number(previousData.session.maps[m].grid_data.size))/Number(previousData.session.maps[m].grid_data['columns']))*100).toString()+'%',
                                    height:(((5/Number(previousData.session.maps[m].grid_data.size))/Number(previousData.session.maps[m].grid_data['rows']))*100).toString()+'%',
                                    position:'absolute'
                                });

                                localContainer.appendChild(pcElement);

                                // Drag & Drop
                                if (cursor == 'move' && uType == 'pc') {
                                    $(pcElement).draggable({
                                        'disabled':false,
                                        //'grid':[50*localMapData[container.id].zoom,50*localMapData[container.id].zoom],
                                        'containment':'parent'
                                    });
                                } else {
                                    $(pcElement).draggable({
                                        'disabled':true
                                    });
                                }
                                $(pcElement).on('dragstop',function(event){
                                    var rect = event.target.getBoundingClientRect();
                                    var pos = convertMouseToMapPos($(event.target).attr('mapId'),rect.left,rect.top);
                                    var args = [
                                        $(event.target).attr('mapId'),
                                        Math.round(pos[0]/50),
                                        Math.round(pos[1]/50)
                                    ];
                                    console.log(args);
                                    scmd(
                                        'move_pc',
                                        args,
                                        function(data){
                                            if (data.code == 200) {
                                                command('gsi',{'sid':params.get('id'),'print':BrowserFingerprint},1023,refresh);
                                            }
                                        }
                                    );
                                });                                
                            }

                            // Add active NPCs to the map
                            for (var c=0;c<Object.keys(previousData.session.maps[m].npcs).length;c++) {
                                var key = Object.keys(previousData.session.maps[m].npcs)[c];
                                var id = Object.keys(previousData.session.maps[m].npcs)[c];
                                console.log(previousData.session.maps[m].npcs[key]);
                                if (typeof(previousData.session.maps[m].npcs[key].data) == "string") {
                                    var data = JSON.parse(previousData.session.maps[m].npcs[key].data);
                                } else {
                                    var data = previousData.session.maps[m].npcs[key].data;
                                }
                                
                                var name = data.name;
                                var position = previousData.session.maps[m].npcs[key].pos;
                                var icon = previousData.session.maps[m].npcs[key].icon;
                                var size = data.size;
                                if (!icon.includes('data') && !icon.includes('/')) {
                                    icon = 'assets/icons/'+iconIndex[icon];
                                }
                                console.log(icon);
                                var npcElement = document.createElement('div');
                                npcElement.id = id;
                                npcElement.setAttribute('mapId',container.id);
                                if (uType == 'dm') {
                                    npcElement.title = 'Name: '+name+' | HP: '+previousData.session.maps[m].npcs[key].hp+'/'+data.hit_points+' | AC: '+data.armor_class;
                                } else {
                                    npcElement.title = name;
                                }
                                
                                npcElement.className = 'npc-icon';
                                npcElement.setAttribute('data',JSON.stringify(data));
                                npcElement.setAttribute('current-hp',previousData.session.maps[m].npcs[key].hp);
                                var npcImg = document.createElement('img');
                                npcImg.src = icon;
                                $(npcImg).css({
                                    'width':'80%',
                                    'height':'80%',
                                    'margin-left':'10%',
                                    'margin-top':'10%'
                                });
                                $(npcImg).on('contextmenu',function(event){
                                    event.preventDefault();
                                    $(event.target.parentElement).trigger('contextmenu',[event.pageX,event.pageY]);
                                });
                                npcElement.appendChild(npcImg);
                                $(npcElement).css({
                                    top:((Number(position[1])/Number(previousData.session.maps[m].grid_data['rows']))*100).toString()+'%',
                                    left:((Number(position[0])/Number(previousData.session.maps[m].grid_data['columns']))*100).toString()+'%',
                                    width:(((sizes[size]/Number(previousData.session.maps[m].grid_data.size))/Number(previousData.session.maps[m].grid_data['columns']))*100).toString()+'%',
                                    height:(((sizes[size]/Number(previousData.session.maps[m].grid_data.size))/Number(previousData.session.maps[m].grid_data['rows']))*100).toString()+'%',
                                    position:'absolute'
                                });

                                localContainer.appendChild(npcElement);

                                // Drag & Drop
                                if (cursor == 'move' && uType == 'dm') {
                                    $(npcElement).draggable({
                                        'disabled':false,
                                        //'grid':[50*localMapData[container.id].zoom,50*localMapData[container.id].zoom],
                                        'containment':'parent'
                                    });
                                } else {
                                    $(npcElement).draggable({
                                        'disabled':true
                                    });
                                }
                                $(npcElement).on('dragstop',function(event){
                                    var rect = event.target.getBoundingClientRect();
                                    var pos = convertMouseToMapPos($(event.target).attr('mapId'),rect.left,rect.top);
                                    var args = [
                                        $(event.target).attr('mapId'),
                                        $(event.target).attr('id'),
                                        $(event.target).attr('data'),
                                        $(event.target).attr('current-hp'),
                                        Math.round(pos[0]/50),
                                        Math.round(pos[1]/50)
                                    ];
                                    if (args[4] < 0) {
                                        args[4] = Math.abs(args[4]);
                                    }
                                    if (args[5] < 0) {
                                        args[5] = Math.abs(args[5]);
                                    }
                                    scmd(
                                        'modify_npc',
                                        args,
                                        function(data){
                                            if (data.code == 200) {
                                                command('gsi',{'sid':params.get('id'),'print':BrowserFingerprint},1023,refresh);
                                            }
                                        }
                                    );
                                });                           
                            }
                            
                            displayArea.appendChild(container);

                            // Drag & Drop code from JQuery UI
                            container.appendChild(localContainer);
                            if (cursor == 'move') {
                                $(container).draggable({
                                    'disabled':false
                                }).appendTo(container).css('position','absolute');
                            } else {
                                $(container).draggable({
                                    'disabled':true
                                }).appendTo(container).css('position','absolute');
                            }
                            $(container).on('dragstop',function(event){
                                if (event.target.classList.contains('pc-icon')||event.target.classList.contains('npc-icon')) {
                                    return;
                                }
                                var rect = event.target.getBoundingClientRect();
                                var position = [
                                    Math.round(rect.left-(window.innerWidth*0.05)).toString(), //-(window.innerWidth*0.05)
                                    Math.round(rect.top-(window.innerHeight*0.05)).toString() //-(window.innerHeight*0.05)
                                ];
                                $(event.delegateTarget).css({
                                    'top':position[1]+'px',
                                    'left':position[0]+'px',
                                    'postion':'absolute'
                                });
                                localMapData[event.delegateTarget.id].pos = position;
                                console.log(position);
                            });

                            $(container).on('wheel',function(event){
                                var topContainer = event.delegateTarget;
                                var Dy = event.originalEvent.deltaY;
                                var zoomMod = Number(topContainer.getAttribute('zoom'));
                                if (Dy < 0) {
                                    zoomMod += 0.05;
                                    var zoomDelta = 1.05;
                                } else if (Dy > 0) {
                                    zoomMod -= 0.05;
                                    var zoomDelta = 0.95;
                                }
                                
                                topContainer.setAttribute('zoom',limit(zoomMod,0.1,2).toString());
                                localMapData[topContainer.id].zoom = limit(zoomMod,0.1,5);
                                var dispArea = document.getElementById('display-area');
                                var dispRect = dispArea.getBoundingClientRect();
                                var topContainerRect = topContainer.getBoundingClientRect();
                                topContainerRect.x = localMapData[topContainer.id].pos[0];
                                topContainerRect.y = localMapData[topContainer.id].pos[1];
                                console.log(topContainerRect);
                                console.log(event.pageX-dispRect.x,event.pageY-dispRect.y);

                                var originDelta = [
                                    (event.pageX - dispRect.x - topContainerRect.x),
                                    (event.pageY - dispRect.y - topContainerRect.y)
                                ];
                                localMapData[topContainer.id].pos = [(event.pageX-dispRect.x) - originDelta[0]*zoomDelta,(event.pageY-dispRect.y) - originDelta[1]*zoomDelta];
                                //localMapData[topContainer.id].pos = newpos;
                                var cid = null;
                                for (var i=0;i<previousData.session.maps.length;i++) {
                                    if (previousData.session.maps[i].id==topContainer.id) {
                                        cid = i;
                                    }
                                }

                                $(topContainer).css({
                                    'width':(50*Number(previousData.session.maps[cid].grid_data.columns*localMapData[topContainer.id].zoom)).toString()+'px',
                                    'height':(50*Number(previousData.session.maps[cid].grid_data.rows*localMapData[topContainer.id].zoom)).toString()+'px',
                                    'top':localMapData[topContainer.id].pos[1].toString() + 'px',
                                    'left':localMapData[topContainer.id].pos[0].toString() + 'px',
                                    'cursor':cursor,
                                    'position':'absolute'
                                });
                                refresh();


                            });

                            
                        }
                    }
                }
            }

            $(document).ready(function(){
                // Page setup
                $('#share-link').text(document.location); // Set the share link
                
                var iconKeys = Object.keys(iconIndex);
                for (var i=0;i<iconKeys.length;i++) {
                    $(
                        '<img src="assets/icons/'+
                        iconIndex[iconKeys[i]]+
                        '">'
                    ).appendTo($([
                        '<div class="npc-icon" id="npc-icon-',
                        iconKeys[i],
                        '" name="',
                        iconKeys[i]
                        ,'"></div>'
                    ].join('')).appendTo($('#npc-icon-select')));
                }

                // Fingerprint setup
                
                setTimeout(function () { // Ready fingerprint generation
                    console.log('FINGERPRINT: '+BrowserFingerprint);
                    command('checkuser',{'fingerprint':BrowserFingerprint},1023,function(data){
                        if (!data['found']) {
                            command('gsi',{'sid':params.get('id'),'print':BrowserFingerprint},1023,function(data){
                                if (data['code'] == 200) {
                                    if (data['hasPassword']) {
                                        command('joinsession',{
                                            'name':prompt('Enter the name you want to display.'),
                                            'id':params.get('id'),
                                            'password':prompt('Enter password to join '+data['name']+'.'),
                                            'fingerprint':BrowserFingerprint
                                        },1023,function(data){
                                            if (Object.keys(data).includes('code')) {
                                                if (data['code'] == 403) {
                                                    bootbox.alert('Password is incorrect.');
                                                    window.location = 'index.html';
                                                } else {
                                                    bootbox.alert('That server does not exist. Please make sure you copied your join link correctly.')
                                                }
                                            } else {
                                                bootbox.alert('Success!');
                                            }
                                        });
                                    } else {
                                        command('joinsession',{
                                            'name':prompt('Enter the name you want to display.'),
                                            'id':params.get('id'),
                                            'password':'',
                                            'fingerprint':BrowserFingerprint
                                        },1023,function(data){
                                            if (Object.keys(data).includes('code')) {
                                                if (data['code'] == 403) {
                                                    bootbox.alert('Password is incorrect.');
                                                    window.location = 'index.html';
                                                } else {
                                                    bootbox.alert('That server does not exist. Please make sure you copied your join link correctly.')
                                                }
                                            } else {
                                                bootbox.alert('Success!');
                                            }
                                        });
                                    }
                                } else {
                                    bootbox.alert('Cannot find that session.');
                                }
                            });
                        } else {
                            console.log(data);
                        }
                    });
                }, 2000);
                
                // Context menu manager

                $(document).contextmenu(function(event,x,y){
                    var keys = Object.keys(ctxMenu);
                    for (var s=0;s<keys.length;s++){
                        var type = keys[s].charAt(0);
                        var name = keys[s].slice(1);
                        var sel = keys[s];
                        var found = false;
                        if (type == '#') {
                            if (event.target.id == name) {
                                found = true;
                                break;
                            }
                        }
                        if (type == '.') {
                            if ($(event.target).hasClass(name)) {
                                found = true
                                break;
                            }
                        }
                    }
                    if (found) {
                        currentCtx = event.target.id;
                        if (event.clientX == undefined) {
                            var cx = x;
                            var cy = y;
                        } else {
                            var cx = event.clientX;
                            var cy = event.clientY;
                        }
                        $('#custom-ctx').css({
                            top:cy+'px',
                            left:cx.toString()+'px'
                        });

                        var children = $('#custom-ctx').children('*');
                        var ct = 0;
                        for (var c=0; c<children.length; c++) {
                            if (Object.keys(ctxMenu[sel]).includes($(children[c]).attr('ctx'))) {
                                if (ctxMenu[sel][$(children[c]).attr('ctx')].includes('|')) {
                                    var allowedUsers = ctxMenu[sel][$(children[c]).attr('ctx')].split('|')[0];
                                    var ctxModifiers = ctxMenu[sel][$(children[c]).attr('ctx')].split('|')[1];
                                } else {
                                    var allowedUsers = ctxMenu[sel][$(children[c]).attr('ctx')];
                                    var ctxModifiers = '';
                                }
                                if (allowedUsers.split(',').includes(uType)) {
                                    var checked = false;
                                    if (ctxModifiers.split(',').includes('self') && uType == 'pc' ) {
                                        if (currentCtx == BrowserFingerprint) {
                                            $(children[c]).toggleClass('active',true);
                                            ct++;
                                        } else {
                                            $(children[c]).toggleClass('active',false);
                                        }
                                        checked = true;
                                    } 
                                    if (ctxModifiers.split(',').includes('!self') && uType == 'pc' ) {
                                        if (currentCtx != BrowserFingerprint && $('#'+currentCtx).hasClass('pc-icon')) {
                                            $(children[c]).toggleClass('active',true);
                                            ct++;
                                        } else {
                                            $(children[c]).toggleClass('active',false);
                                        }
                                        checked = true;
                                    }
                                    if (ctxModifiers.split(',').includes('init')) {
                                        if (previousData.session.initiative.active) {
                                            if (uType == 'pc') {
                                                if (previousData.session.initiative.order[previousData.session.initiative.rolls[previousData.session.initiative.index]].id == BrowserFingerprint) {
                                                    $(children[c]).toggleClass('active',true);
                                                    ct++;
                                                } else {
                                                    $(children[c]).toggleClass('active',false);
                                                }
                                            } else {
                                                if (previousData.session.initiative.order[previousData.session.initiative.rolls[previousData.session.initiative.index]].type == 'dm') {
                                                    $(children[c]).toggleClass('active',true);
                                                    ct++;
                                                } else {
                                                    $(children[c]).toggleClass('active',false);
                                                }
                                            }
                                        } else {
                                            $(children[c]).toggleClass('active',false);
                                        }
                                        checked = true
                                    }
                                    if (ctxModifiers.split(',').includes('!init')) {
                                        if (!previousData.session.initiative.active) {
                                            if (ctxModifiers.split(',').includes('self') && uType == 'pc' ) {
                                                if (currentCtx == BrowserFingerprint) {
                                                    $(children[c]).toggleClass('active',true);
                                                    ct++;
                                                } else {
                                                    $(children[c]).toggleClass('active',false);
                                                }
                                                checked = true;
                                            } else {
                                                $(children[c]).toggleClass('active',true);
                                            }
                                            ct++;
                                        } else {
                                            if (uType == 'pc') {
                                                if (previousData.session.initiative.order[previousData.session.initiative.rolls[previousData.session.initiative.index]].id != BrowserFingerprint) {
                                                    $(children[c]).toggleClass('active',true);
                                                    ct++;
                                                } else {
                                                    $(children[c]).toggleClass('active',false);
                                                }
                                            } else {
                                                if (previousData.session.initiative.order[previousData.session.initiative.rolls[previousData.session.initiative.index]].type != 'dm') {
                                                    $(children[c]).toggleClass('active',true);
                                                    ct++;
                                                } else {
                                                    $(children[c]).toggleClass('active',false);
                                                }
                                            }
                                        }
                                        checked = true
                                    }
                                    if (ctxModifiers.split(',').includes('in_init')) {
                                        if (previousData.session.initiative.active) {
                                            if (uType == 'pc') {
                                                var res = false;
                                                for (var e=0;e<previousData.session.initiative.rolls.length;e++) {
                                                    if (previousData.session.initiative.order[previousData.session.initiative.rolls[e]].id == BrowserFingerprint) {
                                                        res = true;
                                                    }
                                                }
                                                $(children[c]).toggleClass('active',res);
                                                if (ctxModifiers.split(',').includes('self') && uType == 'pc' ) {
                                                    if (currentCtx == BrowserFingerprint) {
                                                        $(children[c]).toggleClass('active',res);
                                                        ct++;
                                                    } else {
                                                        $(children[c]).toggleClass('active',false);
                                                    }
                                                    checked = true;
                                                } 
                                                if (ctxModifiers.split(',').includes('!self') && uType == 'pc' ) {
                                                    if (currentCtx != BrowserFingerprint && $('#'+currentCtx).hasClass('pc-icon')) {
                                                        $(children[c]).toggleClass('active',res);
                                                        ct++;
                                                    } else {
                                                        $(children[c]).toggleClass('active',false);
                                                    }
                                                    checked = true;
                                                }
                                            } else {
                                                var res = false;
                                                for (var e=0;e<previousData.session.initiative.rolls.length;e++) {
                                                    if (previousData.session.initiative.order[previousData.session.initiative.rolls[e]].id == currentCtx) {
                                                        res = true;
                                                    }
                                                }
                                                $(children[c]).toggleClass('active',res);
                                            }
                                        } else {
                                            $(children[c]).toggleClass('active',false);
                                        }
                                        checked = true
                                    }
                                    if (ctxModifiers.split(',').includes('!in_init')) {
                                        if (previousData.session.initiative.active) {
                                            if (uType == 'pc') {
                                                var res = true;
                                                for (var e=0;e<previousData.session.initiative.rolls.length;e++) {
                                                    if (previousData.session.initiative.order[previousData.session.initiative.rolls[e]].id == BrowserFingerprint) {
                                                        res = false;
                                                    }
                                                }
                                                $(children[c]).toggleClass('active',res);
                                                if (ctxModifiers.split(',').includes('self') && uType == 'pc' ) {
                                                    if (currentCtx == BrowserFingerprint) {
                                                        $(children[c]).toggleClass('active',res);
                                                        ct++;
                                                    } else {
                                                        $(children[c]).toggleClass('active',false);
                                                    }
                                                    checked = true;
                                                } 
                                                if (ctxModifiers.split(',').includes('!self') && uType == 'pc' ) {
                                                    if (currentCtx != BrowserFingerprint && $('#'+currentCtx).hasClass('pc-icon')) {
                                                        $(children[c]).toggleClass('active',res);
                                                        ct++;
                                                    } else {
                                                        $(children[c]).toggleClass('active',false);
                                                    }
                                                    checked = true;
                                                }
                                            } else {
                                                var res = true;
                                                for (var e=0;e<previousData.session.initiative.rolls.length;e++) {
                                                    if (previousData.session.initiative.order[previousData.session.initiative.rolls[e]].id == currentCtx) {
                                                        res = false;
                                                    }
                                                }
                                                $(children[c]).toggleClass('active',res);
                                            }
                                        } else {
                                            $(children[c]).toggleClass('active',true);
                                        }
                                        checked = true
                                    }
                                    if (!checked) {
                                        $(children[c]).toggleClass('active',true);
                                        ct++;
                                    }
                                } else { $(children[c]).toggleClass('active',false); }
                            } else { $(children[c]).toggleClass('active',false); }
                        }
                        if (ct > 0) {
                            $('#custom-ctx').toggleClass('active',true);
                        }
                        event.preventDefault();
                    }
                });
                $(document).click(function(event){
                    if (event.target == undefined) {
                        $('#custom-ctx').toggleClass('active',false);
                        $('#custom-ctx *').toggleClass('active',false);
                        currentCtx = null;
                    }
                    if ($(event.target).attr('id')!='custom-ctx') {
                        $('#custom-ctx').toggleClass('active',false);
                        $('#custom-ctx *').toggleClass('active',false);
                        currentCtx = null;
                    }
                    
                });

                // Button functions
                $('#save-session').click(function(){ // Save the current session to a file
                    command('scmd',{
                        'sid':params.get('id'),
                        'fingerprint':BrowserFingerprint,
                        'command':'save',
                        'args':0
                    },1023,function(data){
                        var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data['save']));
                        saveAs(dataStr,'session.json');
                    });
                });

                $('#share-link').click(function() { // Copying the share link
                    var id = 'share-link';
                    var el = document.getElementById(id);
                    var range = document.createRange();
                    range.selectNodeContents(el);
                    var sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                    document.execCommand('copy');
                    $(this).attr('data-tooltip','Copied!');
                    window.setTimeout(function(){$('#share-link').attr('data-tooltip','Click to Copy')},2000);
                });

                $('#submit-nick').click(function(){ // Change player nickname
                    if ($('#change-nick-input').val() == '') {
                        $('#change-nick-input').toggleClass('invalid',true);
                        return;
                    } else {
                        $('#change-nick-input').toggleClass('invalid',false);
                    }
                    $('.active').toggleClass('active',false);
                    $('.invalid').toggleClass('invalid',false);
                    command('editname',{
                        'sid':params.get('id'),
                        'fingerprint':BrowserFingerprint,
                        'name':$('#change-nick-input').val()
                    },1023,function(data){
                        if (data['code'] == 404) {
                            bootbox.alert('Error: '+data['reason']);
                        }
                    });
                });

                $('#settings-submit').click(function(){ // Finish modifying settings
                    if ($('#session-name-set').val() == '') {
                        $('#session-name-set').toggleClass('invalid',true);
                        return;
                    } else {
                        $('#session-name-set').toggleClass('invalid',false);
                    }
                    $('.active').toggleClass('active',false);
                    $('.invalid').toggleClass('invalid',false);
                    command('modsession',{
                        'sid':params.get('id'),
                        'fingerprint':BrowserFingerprint,
                        'newname':$('#session-name-set').val(),
                        'newpass':$('#session-psw-set').val()
                    },1023,function(data){
                        if (data.code != 200) {
                            bootbox.alert(data.reason);
                        }
                    });
                });
                $('#session-reset').click(function(){ // Purge all session info (maps & characters)
                    if (confirm('Are you sure? This action is irreversible unless you have saved a copy of this session.')) {
                        command('purge',{
                            'sid':params.get('id'),
                            'fingerprint':BrowserFingerprint
                        },1023,function(data){
                            if (data.code != 200) {
                                bootbox.alert(data.reason);
                            }
                        })
                    }
                });

                $('#set-sheet-input').keyup(function(){ // Update iframe to display sheet.
                    $('#sheet-frame').attr('src',$('#set-sheet-input').val());
                    if ($('#set-sheet-input').val().includes('spreadsheets')) {
                        $('#sheet-frame').show(0);
                    } else {
                        $('#sheet-frame').hide(0);
                    }
                });
                $('#submit-sheet').click(function(){ // Submit sheet
                    if ($('#set-sheet-input').val() == '') {
                        $('#set-sheet-input').toggleClass('invalid',true);
                        return;
                    } else {
                        $('#set-sheet-input').toggleClass('invalid',false);
                    }
                    $('.active').toggleClass('active',false);
                    $('.invalid').toggleClass('invalid',false);
                    command('scmd',{
                        'sid':params.get('id'),
                        'fingerprint':BrowserFingerprint,
                        'command':'load_sheet',
                        'args':$('#set-sheet-input').val()
                    },1023,function(data){
                        if (data['code'] == 200) {
                            bootbox.alert('Sheet loaded.');
                        } else {
                            bootbox.alert('Error: '+data['reason']);
                        }
                    });
                });

                // Loading maps
                $('#load-map').click(function(){$('#load-map-file').click()});
                $('#load-map-file').change(function(){
                    var file = document.getElementById('load-map-file').files[0];
                    var reader = new FileReader();
                    reader.addEventListener("load", function () {
                        if ($('#map-rows').val() == '') {
                            var rows = 20;
                        } else {
                            var rows = $('#map-rows').val();
                        }
                        if ($('#map-cols').val() == '') {
                            var cols = 20;
                        } else {
                            var cols = $('#map-cols').val();
                        }
                        if ($('#grid-size-inp').val() == '') {
                            var gs = 5;
                        } else {
                            var gs = $('#grid-size-inp').val();
                        }

                        scmd('load_map',[reader.result,rows,cols,gs],refresh);
                    }, false);
                
                    if (file) {
                        reader.readAsDataURL(file);
                    }
                });

                // NPC Maker
                $('#npc-search').keyup(function(event){
                    if ($('#npc-search').val().length > 0) {
                        scmd('open5e',['monsters','search,'+$('#npc-search').val(),'limit,50'],function(data){
                            if (data.code == 200) {
                                var initialParse = JSON.parse(data.result);
                                document.getElementById('search-results').innerHTML = '';
                                for (var n=0;n<initialParse.data.length;n++) {
                                    var point = initialParse.data[n];
                                    var name = point.name;
                                    var type = point.type
                                    var hp = point.hit_points.toString();
                                    var cr = point.challenge_rating;
                                    var slug = point.slug;
                                    $('<div class="npc-info-block"><span>'+[
                                            'Name: <a href="https://open5e.com/monsters/'+slug+'" target="_blank">'+name+'</a>',
                                            'Type: '+type,
                                            'HP: '+hp,
                                            'CR: '+cr
                                        ].join('</span><span>')+'</span></div>')
                                        .attr('data',JSON.stringify(point))
                                        .click(function(event){
                                            var data = JSON.parse($(event.delegateTarget).attr('data'));
                                            $('#npc-name-inp').val(data.name);
                                            $('#npc-hp-inp').val(data.hit_points);
                                            $('.npc-icon').removeClass('selected');
                                            if (data.img_main) {
                                                $('#npc-icon-open5e').toggleClass('selected',true);
                                                $('#npc-icon-open5e img').attr('src',data.img_main);
                                                $('#npc-icon-open5e').css('display','inline-block');
                                            } else if (data.type == 'dragon') {
                                                $('#npc-icon-Dragon').toggleClass('selected',true);
                                                $('#npc-icon-open5e').css('display','none');
                                            } else if (data.name.toLowerCase().includes('mimic')) {
                                                $('#npc-icon-Treasure').toggleClass('selected',true);
                                                $('#npc-icon-open5e').css('display','none');
                                            } else {
                                                $('#npc-icon-Dice').toggleClass('selected',true);
                                                $('#npc-icon-open5e').css('display','none');
                                            }
                                            npcData.data = data;
                                        })
                                        .appendTo($('#search-results'));
                                }
                            }
                        });
                    }
                });
                $('.npc-icon').click(function(event){
                    $('.npc-icon').toggleClass('selected',false);
                    $(event.delegateTarget).toggleClass('selected',true);
                });
                $('#npc-submit').click(function(event){
                    $('#modal-back').click();
                    npcData.data.name = $('#npc-name-inp').val();
                    npcData.data.hit_points = Number($('#npc-hp-inp').val());
                    npcData.makingNPC = false;

                    if ($('.npc-icon.selected')[0].getAttribute('name') == 'open5e') {
                        icon = $('.npc-icon.selected img')[0].getAttribute('src');
                    } else {
                        icon = $('.npc-icon.selected')[0].getAttribute('name');
                    }

                    scmd('add_npc',[
                        npcData.map,
                        icon,
                        JSON.stringify(npcData.data),
                        npcData.pos[0],
                        npcData.pos[1]
                    ],console.log);
                });

                // Map Buttons
                $('#remove-map').click(function(){
                    scmd('delete_map',[$('#maps-area .selected').attr('id')],refresh);
                    $('#map-actions').toggleClass('active',false);
                });
                $('#place-map').click(function(){
                    var mapData = JSON.parse($('#maps-area .selected').attr('data'));
                    scmd('modify_map',[
                    $('#maps-area .selected').attr('id'),
                    mapData.grid_data.rows,
                    mapData.grid_data.columns,
                    mapData.grid_data.size,true
                    ],refresh);
                    $('#map-actions').toggleClass('active',false);
                });
                $('#mod-map').click(function(){
                    var mapData = JSON.parse($('#maps-area .selected').attr('data'));

                    if ($('#map-rows').val() == '') {
                        var rows = mapData.grid_data.rows;
                    } else {
                        var rows = $('#map-rows').val();
                    }
                    if ($('#map-cols').val() == '') {
                        var cols = mapData.grid_data.columns;
                    } else {
                        var cols = $('#map-cols').val();
                    }
                    if ($('#grid-size-inp').val() == '') {
                        var gs = mapData.grid_data.size;
                    } else {
                        var gs = $('#grid-size-inp').val();
                    }

                    scmd('modify_map',[
                    $('#maps-area .selected').attr('id'),
                    rows,
                    cols,
                    gs,
                    mapData.active
                    ],refresh);
                    $('#map-actions').toggleClass('active',false);
                });

                $('#cursors-bar button').click(function(event){
                    cursor = event.delegateTarget.getAttribute('name');
                    
                    console.log(event.delegateTarget);
                    console.log(cursor);
                    refresh();
                });

                // Refresh Loop
                window.setInterval(function(){
                    command('gsi',{'sid':params.get('id'),'print':BrowserFingerprint},1023,refresh);
                },400);

                // Button Cosmetics
                $('#modal-back').click(function(){$('.active').toggleClass('active',false);$('.invalid').toggleClass('invalid',false);});
                $('#edit-name').click(function(){
                    $('#modal-back').toggleClass('active',true);
                    $('#change-name-dialog').toggleClass('active',true);
                });
                $('#update-sheet').click(function(){
                    scmd(
                        'update_sheet',
                        ['0'],
                        function(data){
                            console.log(data);
                            command('gsi',{'sid':params.get('id'),'print':BrowserFingerprint},1023,refresh);
                        }
                    );
                });
                $('#set-sheet').click(function(){
                    $('#modal-back').toggleClass('active',true);
                    $('#set-sheet-dialog').toggleClass('active',true);
                    $('#set-sheet-input').val('');
                    $('#sheet-frame').hide(0);
                });
                $('#settings').click(function(){
                    $('#modal-back').toggleClass('active',true);
                    $('#session-name-set').val(previousData.name);
                    $('#settings-menu').toggleClass('active',true);
                });
                $('#adv-init').click(function(){
                    scmd(
                        'initiative',
                        ['next',$('#'+currentCtx).attr('mapId'),-1],
                        console.log
                    );
                    scmd(
                        'initiative',
                        ['check',$('#'+currentCtx).attr('mapId'),$('#'+currentCtx).attr('id')],
                        function(data){
                            $('#ci-img').attr('src',getIcon(data.current.icon));
                            $('#ni-img').attr('src',getIcon(data.next.icon));
                            $('#current-init').attr('data-tooltip',data.current.name);
                            $('#next-init').attr('data-tooltip',data.next.name);
                            console.log(data);
                        }
                    );
                });
                $('#adv-stop').click(function(){
                    scmd(
                        'initiative',
                        ['end',$('#'+currentCtx).attr('mapId'),-1],
                        function(data) {
                            return;
                        }
                    );
                });
                $('#manage-maps').click(function(){
                    $('#modal-back').toggleClass('active',true);
                    $('#manage-maps-menu').toggleClass('active',true);
                    $('#maps-area img').toggleClass('selected',false);
                    refresh();
                });

                // Context menu actions
                $('#ctx_map-close').click(function(event){
                    var mapData = JSON.parse($('#'+currentCtx).attr('data'));
                    scmd('modify_map',[
                    $('#'+currentCtx).attr('id'),
                    mapData.grid_data.rows,
                    mapData.grid_data.columns,
                    mapData.grid_data.size,false
                    ],refresh);
                    $(document).click();
                });
                $('#ctx_add-pc').click(function(event){
                    var pos = convertMouseToMapPos(currentCtx,event.pageX,event.pageY);
                    var args = [
                        currentCtx,
                        'Dice',
                        roundTo(pos[0],50)/50,
                        roundTo(pos[1],50)/50
                    ];
                    scmd(
                        'activate_pc',
                        args,
                        console.log
                    );
                    $(document).click();
                });
                $('#ctx_remove-pc').click(function(event){
                    scmd(
                        'deactivate_pc',
                        [$('#'+currentCtx).attr('mapId')],
                        console.log
                    );
                    $(document).click();
                });
                $('#ctx_remove-pc-dm').click(function(event){
                    console.log(currentCtx);
                    scmd(
                        'deactivate_pc_dm',
                        [$('#'+currentCtx).attr('mapId'),currentCtx],
                        console.log
                    );
                    $(document).click();
                });
                $('#ctx_add-npc').click(function(event){
                    var _pos = convertMouseToMapPos(currentCtx,event.pageX,event.pageY);
                    var pos = [roundTo(_pos[0],50)/50,roundTo(_pos[1],50)/50];
                    npcData.makingNPC = true;
                    npcData.pos = pos;
                    npcData.map = currentCtx;
                    $('#npc-menu input').val('');
                    $('#npc-menu').toggleClass('active',true);
                    $('#modal-back').toggleClass('active',true);
                    $(document).click();
                });
                $('#ctx_remove-npc').click(function(event){
                    scmd(
                        'remove_npc',
                        [$('#'+currentCtx).attr('mapId'),$('#'+currentCtx).attr('id')],
                        console.log
                    );
                    $(document).click();
                });
                
                $('#ctx_run-initiative').click(function(event){
                    if ($('#'+currentCtx).hasClass('npc-icon')) {
                        scmd(
                            'initiative',
                            ['roll',$('#'+currentCtx).attr('mapId'),$('#'+currentCtx).attr('id')],
                            console.log
                        );
                    } else {
                        scmd(
                            'initiative',
                            ['roll',$('#'+currentCtx).attr('mapId'),-1],
                            console.log
                        );
                    }
                    $(document).click();
                    scmd(
                        'initiative',
                        ['check',$('#'+currentCtx).attr('mapId'),$('#'+currentCtx).attr('id')],
                        function(data){
                            $('#ci-img').attr('src',getIcon(data.current.icon));
                            $('#ni-img').attr('src',getIcon(data.next.icon));
                            $('#current-init').attr('data-tooltip',data.current.name);
                            $('#next-init').attr('data-tooltip',data.next.name);
                        }
                    );
                });
                $('#ctx_remove-initiative').click(function(event){
                    if ($('#'+currentCtx).hasClass('npc-icon')) {
                        scmd(
                            'initiative',
                            ['remove',$('#'+currentCtx).attr('mapId'),$('#'+currentCtx).attr('id')],
                            console.log
                        );
                    } else {
                        scmd(
                            'initiative',
                            ['remove',$('#'+currentCtx).attr('mapId'),-1],
                            console.log
                        );
                    }
                    $(document).click();
                    scmd(
                        'initiative',
                        ['check',$('#'+currentCtx).attr('mapId'),$('#'+currentCtx).attr('id')],
                        function(data){
                            $('#ci-img').attr('src',getIcon(data.current.icon));
                            $('#ni-img').attr('src',getIcon(data.next.icon));
                            $('#current-init').attr('data-tooltip',data.current.name);
                            $('#next-init').attr('data-tooltip',data.next.name);
                        }
                    );
                });
                $('#ctx_set-pc-hp').click(function(event){
                    var new_hp = Number(prompt('Enter new HP amount.'));
                    if (isNaN(new_hp)) {
                        bootbox.alert('Please enter a number.');
                        return;
                    }
                    if (new_hp <= previousData.session.characters[currentCtx].max_hp && new_hp >= 0) {
                        scmd(
                            'modify_pc',
                            [currentCtx,-1,[['hp',new_hp]]],
                            function(){
                                command('gsi',{'sid':params.get('id'),'print':BrowserFingerprint},1023,refresh);
                            }
                        );
                    } else {
                        bootbox.alert('The new HP value must be between 0 and '+previousData.session.characters[currentCtx].max_hp);
                    }
                });
                $('#ctx_set-pc-max-hp').click(function(event){
                    var new_hp = Number(prompt('Enter new Max HP amount.'));
                    if (isNaN(new_hp)) {
                        bootbox.alert('Please enter a number.');
                        return;
                    }
                    if (new_hp >= 0) {
                        if (new_hp < previousData.session.characters[currentCtx].hp) {
                            scmd(
                                'modify_pc',
                                [currentCtx,-1,[['hp',new_hp],['max_hp',new_hp]]],
                                function(){
                                    command('gsi',{'sid':params.get('id'),'print':BrowserFingerprint},1023,refresh);
                                }
                            );
                        } else {
                            scmd(
                                'modify_pc',
                                [currentCtx,-1,[['max_hp',new_hp]]],
                                function(){
                                    command('gsi',{'sid':params.get('id'),'print':BrowserFingerprint},1023,refresh);
                                }
                            );
                        }
                    } else {
                        bootbox.alert('The new HP value must be greater than 0.');
                    }
                });
                $('#ctx_change-pc-hp').click(function(event){
                    var change = Number(prompt('Enter HP change (positive or negative).'));
                    if (isNaN(change)) {
                        bootbox.alert('Please enter a number.');
                        return;
                    }
                    var new_hp = previousData.session.characters[currentCtx].hp + change;
                    if (new_hp > previousData.session.characters[currentCtx].max_hp) {
                        new_hp = previousData.session.characters[currentCtx].max_hp;
                    } else if (new_hp < 0) {
                        new_hp = 0;
                    }
                    scmd(
                        'modify_pc',
                        [currentCtx,-1,[['hp',new_hp]]],
                        function(){
                            command('gsi',{'sid':params.get('id'),'print':BrowserFingerprint},1023,refresh);
                        }
                    );
                });
                $('#ctx_edit-pc').click(function(event){
                    $('#pc-editor').attr('editing',currentCtx);
                    $('#hp-input').val(previousData.session.characters[currentCtx].hp);
                    $('#max-hp-input').val(previousData.session.characters[currentCtx].max_hp);
                    $('#ac-input').val(previousData.session.characters[currentCtx].ac);
                    $('#init-input').val(previousData.session.characters[currentCtx].skills.initiative.value);
                    for (var s=0;s<SCORES.length;s++) {
                        $('#'+SCORES[s][0]+'-score-input').val(previousData.session.characters[currentCtx].stats[SCORES[s][1]]);
                        var mod = getmod(previousData.session.characters[currentCtx].stats[SCORES[s][1]]);
                        if (mod > 0) {
                            mod = '+'+mod;
                        }
                        $('#'+SCORES[s][0]+'-bonus .value').text(mod);
                        var mod = getmod(previousData.session.characters[currentCtx].stats[SCORES[s][1]]);
                        if (previousData.session.characters[currentCtx].saves[SCORES[s][1]+'Save'].prof == 1) {
                            mod = mod + previousData.session.characters[currentCtx].stats.prof_bonus;
                        }
                        if (mod > 0) {
                            mod = '+'+mod;
                        }
                        $('#'+SCORES[s][0]+'-save .value').text(mod);
                    }

                    for (var s=0;s<SKILLS.length;s++) {
                        var mod = previousData.session.characters[currentCtx].skills[SKILLS[s]].value;
                        if (mod > 0) {
                            mod = '+'+mod;
                        }
                        $('#'+SKILLS[s]+'-skill').text(mod);
                    }

                    $('#modal-back').toggleClass('active',true);
                    $('#pc-editor').toggleClass('active',true);
                });
                $('#pc-editor input').change(function(event){
                    var editing = $('#pc-editor').attr('editing');
                    if (/^\d+$/.test($(event.target).val())) {
                        var val = Number($(event.target).val());
                        if (val < Number(event.target.min)) {
                            val = Number(event.target.min);
                        }
                        if (val > Number(event.target.max)) {
                            val = Number(event.target.max);
                        }
                        var key = $(event.target).attr('key');
                        console.log(key,val);
                        scmd(
                            'modify_pc',
                            [editing,-1,[[key,val]]],
                            function(){
                                command('gsi',{'sid':params.get('id'),'print':BrowserFingerprint},1023,function(data){
                                    refresh(data);
                                    var editing = $('#pc-editor').attr('editing');
                                    $('#hp-input').val(data.session.characters[editing].hp);
                                    $('#max-hp-input').val(data.session.characters[editing].max_hp);
                                    $('#ac-input').val(data.session.characters[editing].ac);
                                    $('#init-input').val(data.session.characters[editing].skills.initiative.value);
                                    for (var s=0;s<SCORES.length;s++) {
                                        $('#'+SCORES[s][0]+'-score-input').val(data.session.characters[editing].stats[SCORES[s][1]]);
                                        var mod = getmod(data.session.characters[editing].stats[SCORES[s][1]]);
                                        if (mod > 0) {
                                            mod = '+'+mod;
                                        }
                                        $('#'+SCORES[s][0]+'-bonus .value').text(mod);
                                        var mod = getmod(data.session.characters[editing].stats[SCORES[s][1]]);
                                        if (data.session.characters[editing].saves[SCORES[s][1]+'Save'].prof == 1) {
                                            mod = mod + data.session.characters[editing].stats.prof_bonus;
                                        }
                                        if (mod > 0) {
                                            mod = '+'+mod;
                                        }
                                        $('#'+SCORES[s][0]+'-save .value').text(mod);
                                    }

                                    for (var s=0;s<SKILLS.length;s++) {
                                        var mod = data.session.characters[editing].skills[SKILLS[s]].value;
                                        if (mod > 0) {
                                            mod = '+'+mod;
                                        }
                                        $('#'+SKILLS[s]+'-skill').text(mod);
                                    }
                                });
                            }
                        );
                    } else {
                        $(event.target).val('');
                    }
                });
                $('#ctx_claim-pc').click(function(event){
                    scmd(
                        'assign_pc',
                        [currentCtx],
                        function(){
                            command('gsi',{'sid':params.get('id'),'print':BrowserFingerprint},1023,refresh);
                        }
                    );
                });
            });


            
        </script>

        <link rel="stylesheet" type="text/css" href="style/common.css">
        <link rel="stylesheet" type="text/css" href="style/tooltips.css">
        <link rel="stylesheet" type="text/css" href="style/map.css">
    </head>
    <body>
        <div id="modal-back"></div>
        <iframe id="downloader" style="display:none;"></iframe>
        <div id='custom-ctx'>
            <button class='ctx-button' id='ctx_map-close' ctx='map-close'>Close Map</button>
            <button class='ctx-button' id='ctx_add-pc' ctx='add-pc'>Add Player Character</button>
            <button class='ctx-button' id='ctx_add-npc' ctx='add-npc'>Add NPC</button>
            <button class='ctx-button' id='ctx_remove-pc' ctx='remove-pc'>Close Player Character</button>
            <button class='ctx-button' id='ctx_remove-pc-dm' ctx='remove-pc-dm'>Close Player Character</button>
            <button class='ctx-button' id='ctx_remove-npc' ctx='remove-npc'>Remove NPC</button>
            <button class='ctx-button' id='ctx_run-initiative' ctx='run-initiative'>Roll Initiative</button>
            <button class='ctx-button' id='ctx_remove-initiative' ctx='remove-initiative'>Remove From Initiative</button>
            <button class='ctx-button' id='ctx_end-initiative' ctx='end-initiative'>End Initiative</button>
            <button class='ctx-button' id='ctx_set-pc-hp' ctx='set-pc-hp'>Set HP</button>
            <button class='ctx-button' id='ctx_set-pc-max-hp' ctx='set-pc-max-hp'>Set Maximum HP</button>
            <button class='ctx-button' id='ctx_change-pc-hp' ctx='change-pc-hp'>Change HP</button>
            <button class='ctx-button' id='ctx_edit-pc' ctx='edit-pc'>Edit Statistics</button>
            <button class='ctx-button' id='ctx_claim-pc' ctx='claim-pc'>Claim Character</button>
        </div>

        <div id='cursors-bar'>
            <button id='set-cursor-normal' name='default'><img src="assets/cursor.png"><div>Select</div></button>
            <button id='set-cursor-move' name='move'><img src="assets/move.png"><div>Move</div></button>
            <button id='set-cursor-obscure' name='crosshair' class='dm-only'><img src="assets/obscure.png"><div>Obscure</div></button>
        </div>

        <div id='top-bar'>
            <h3 id='session-name'>Session Name: NULL</h3>
            <h3>Share Link</h3>
            <div id='share-link' data-tooltip='Click to Copy' data-tooltip-location="bottom">NULL</div>
        </div>
        <div id='users-bar'>
            <div id='user-area'></div>
            <div class='user-buttons' id='player-buttons'>
                <button id='edit-name' data-tooltip='Edit Player Name' data-tooltip-location="right"><img src="assets/editname.png"></button>
                <button id='set-sheet' data-tooltip='Import Sheet' data-tooltip-location="right"><img src="assets/sheet.png"></button>
                <button id='update-sheet' data-tooltip='Update Sheet' data-tooltip-location="right"><img src="assets/update_sheet.png"></button>
                <button id='set-icon' data-tooltip='Set Player Icon' data-tooltip-location="right"><img src="assets/avatar.png"></button>
            </div>
            <div class='user-buttons' id='dm-buttons'>
                <button id='save-session' data-tooltip='Save Session' data-tooltip-location="right"><img src="assets/save.png"></button>
                <button id='manage-maps' data-tooltip='Manage Maps' data-tooltip-location="right"><img src="assets/map.png"></button>
                <input id='load-map-file' style='display: none;' type="file">
                <button id='settings' data-tooltip='Settings' data-tooltip-location="right"><img src="assets/settings.png"></button>
                <button id='adv-init' data-tooltip='Advance Initiative' data-tooltip-location="right"><img src="assets/next.png"></button>
                <button id='adv-stop' data-tooltip='End Initiative' data-tooltip-location="right"><img src="assets/stop.png"></button>
            </div>
        </div>
        
        <div id='display'>
            <div id='display-area'></div>
        </div>

        <div id='icon-attribution' class='noscroll'>
            <img src='assets/uparrow.png' width="32px" height="32px">
            <p>Nickname Icon: <a href="https://www.flaticon.com/authors/bqlqn" title="bqlqn">bqlqn</a> from <a href="https://www.flaticon.com/" title="Flaticon"> www.flaticon.com</a></p>
            <p>Up Arrow Icon: <a href="https://www.flaticon.com/authors/roundicons" title="Roundicons">Roundicons</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>Sheet Icon: <a href="https://creativemarket.com/Becris" title="Becris">Becris</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>User Icon: <a href="http://www.freepik.com/" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>Class Icons: <a href="https://www.enworld.org/threads/class-icons.517189/" title="EN WORLD">EN WORLD</a></p>
            <p>Save Icon: <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>Map Icon: <a href="https://creativemarket.com/Becris" title="Becris">Becris</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>Settings Icon: <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>Dragon Icon: <a href="https://www.flaticon.com/authors/icongeek26" title="Icongeek26">Icongeek26</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>Treasure Chest Icon: <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>Trash Can Icon: <a href="https://www.flaticon.com/free-icon/delete_1214594" title="Kiranshastry">Kiranshastry</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>Place Map Icon: <a href="https://www.flaticon.com/authors/roundicons" title="Roundicons">Roundicons</a> from <a href="https://www.flaticon.com/" title="Flaticon"> www.flaticon.com</a></p>
            <p>Basic Cursor Icon: <a href="https://icon54.com/" title="Pixel perfect">Pixel perfect</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>Move Cursor Icon: <a href="https://www.flaticon.com/authors/roundicons" title="Roundicons">Roundicons</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>Obscuration Cursor Icon: <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>Advance Initiative Icon: <a href="https://www.flaticon.com/authors/pixel-perfect" title="Pixel perfect">Pixel perfect</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>End Initiative Icon: <a href="https://www.flaticon.com/free-icon/no-stopping_803294" title="Those Icons">Those Icons</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
            <p>Refresh Icon: <a href="http://www.freepik.com/" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon"> www.flaticon.com</a></p>
        </div>

        <!-- Dialogs -->
        <div id='change-name-dialog' class='dialog'>
            <p>Change nickname:</p>
            <input id='change-nick-input' placeholder="Nickname" size="30">
            <button id='submit-nick'>Change Nickname</button>
        </div>

        <div id='set-sheet-dialog' class='dialog'>
            <p>Enter sheet URL (GSheet2 or D&D Beyond):</p>
            <input id='set-sheet-input' placeholder="URL" size="30">
            <iframe src='null' id='sheet-frame'><p>Entered URL does not link to a sheet.</p></iframe>
            <button id='submit-sheet'>Set Sheet</button>
        </div>

        <!-- Large Dialogs -->

        <!-- Settings -->
        <div id='settings-menu' class='large-dialog'>
            <h2>Settings</h2>
            <div class='block'>
                <h3>Set Session Name</h3>
                <input id='session-name-set' placeholder="Set Name" size="30">
            </div>
            <div class='block'>
                <h3>Set Session Password</h3>
                <input id='session-psw-set' placeholder="Set Password" size="30">
            </div>
            <div class='block'>
                <h3>Purge Session</h3>
                <button id='session-reset'>Purge</button>
            </div>
            <button class='submit-button' id='settings-submit'>Finish</button>
        </div>

        <!-- Map manager -->
        <div id='manage-maps-menu' class="large-dialog">
            <h2>Manage Maps</h2>
            <div class='action-btns' id='map-actions'>
                <button id='remove-map' data-tooltip="Remove Map"><img src="assets/delete.png"></button>
                <button id='place-map' data-tooltip="Place Map"><img src="assets/place.png"></button>
                <button id='mod-map' data-tooltip="Change Map Dimensions & Grid Size"><img src="assets/settings.png"></button>
            </div>
            <div class='inline-block' id='maps-area'></div>
            <div class='inline-block' id='map-options'>
                <h3 style="width: 20%;text-align:center;">Map Size</h3>
                <input style="width: 33%; text-align: center;" id="map-rows" type="number" placeholder="Rows" value='20'><span style="color: rgb(239, 243, 251);width:4%;font-family:roboto;text-align: center;"> X </span><input style="width: 33%; text-align: center;" id="map-cols" type="number" placeholder="Columns" value='20'>
                <h3 style="width: 20%;text-align:center;margin-top:2%;">Grid Size</h3>
                <input style="width: 73%; text-align: center;" type="number" id="grid-size-inp" placeholder="Grid Size (feet)" value='5'>
                <button style="width: 100%;margin-top: 2vh;" id='load-map'>Load New Map</button>
            </div>
        </div>

        <!-- NPC Maker -->
        <div id='npc-menu' class="large-dialog">
            <h2>NPC Maker</h2>
            <div class='inline-block' id='search-bar'>
                <h3 style="width: 20%;text-align:center;">NPC/Monster Search</h3>
                <input style="width: 74%; text-align: center;" id="npc-search" placeholder="Search...">
            </div>
            <div class='inline-block' id='search-results'></div>
            <div class='inline-block' id='mod-inputs'>
                <h3 style="width: 10%;text-align:center;">Name</h3>
                <input style="width: 36%; text-align: center;" id="npc-name-inp" placeholder="Name">
                <h3 style="width: 10%;text-align:center;">Hit Points</h3>
                <input style="width: 36%; text-align: center;" id="npc-hp-inp" placeholder="Hit Points" type="number">
            </div>
            <br>
            <div id='npc-icon-select'>
                <div class="npc-icon" id="npc-icon-open5e" name="open5e" style="display: none;"><img src="assets/icons/Dice.png"></div>
            </div>
            <button class='submit-button' id='npc-submit'>Create NPC</button>
        </div>

        <!-- PC Stat Editor -->
        <div id='pc-editor' class="large-dialog" editing='null'>
            <h2>PC Stats Editor</h2>
            <div id='stats-scores-editor' class='block'>
                <table>
                    <thead>
                        <tr>
                            <th>STR</th>
                            <th>DEX</th>
                            <th>CON</th>
                            <th>INT</th>
                            <th>WIS</th>
                            <th>CHA</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id='scores-row'>
                            <td><input id='str-score-input' value='0' placeholder="STR" maxlength="2" type="number" min="0" max="30" key='stats.strength'></td>
                            <td><input id='dex-score-input' value='0' placeholder="DEX" maxlength="2" type="number" min="0" max="30" key='stats.dexterity'></td>
                            <td><input id='con-score-input' value='0' placeholder="CON" maxlength="2" type="number" min="0" max="30" key='stats.constitution'></td>
                            <td><input id='int-score-input' value='0' placeholder="INT" maxlength="2" type="number" min="0" max="30" key='stats.intelligence'></td>
                            <td><input id='wis-score-input' value='0' placeholder="WIS" maxlength="2" type="number" min="0" max="30" key='stats.wisdom'></td>
                            <td><input id='cha-score-input' value='0' placeholder="CHA" maxlength="2" type="number" min="0" max="30" key='stats.charisma'></td>
                        </tr>
                        <tr id='bonus-row' class='view-row'>
                            <td id='str-bonus'>STR Modifier: <span class='value'>0</span></td>
                            <td id='dex-bonus'>DEX Modifier: <span class='value'>0</span></td>
                            <td id='con-bonus'>CON Modifier: <span class='value'>0</span></td>
                            <td id='int-bonus'>INT Modifier: <span class='value'>0</span></td>
                            <td id='wis-bonus'>WIS Modifier: <span class='value'>0</span></td>
                            <td id='cha-bonus'>CHA Modifier: <span class='value'>0</span></td>
                        </tr>
                        <tr id='saves-row' class='view-row'>
                            <td id='str-save'>STR Save: <span class='value'>0</span></td>
                            <td id='dex-save'>DEX Save: <span class='value'>0</span></td>
                            <td id='con-save'>CON Save: <span class='value'>0</span></td>
                            <td id='int-save'>INT Save: <span class='value'>0</span></td>
                            <td id='wis-save'>WIS Save: <span class='value'>0</span></td>
                            <td id='cha-save'>CHA Save: <span class='value'>0</span></td>
                        </tr>
                        <tr id='skills-1' class='view-row'>
                            <td>Athletics: <span id='athletics-skill' class='value'>0</span></td>
                            <td>Acrobatics: <span id='acrobatics-skill' class='value'>0</span></td>
                            <td> - </td>
                            <td>Arcana: <span id='arcana-skill' class='value'>0</span></td>
                            <td>Animal Handling: <span id='animalHandling-skill' class='value'>0</span></td>
                            <td>Deception: <span id='deception-skill' class='value'>0</span></td>
                        </tr>
                        <tr id='skills-2' class='view-row'>
                            <td> - </td>
                            <td>Sleight of Hand: <span id='sleightOfHand-skill' class='value'>0</span></td>
                            <td> - </td>
                            <td>History: <span id='history-skill' class='value'>0</span></td>
                            <td>Insight: <span id='insight-skill' class='value'>0</span></td>
                            <td>Intimidation: <span id='intimidation-skill' class='value'>0</span></td>
                        </tr>
                        <tr id='skills-3' class='view-row'>
                            <td> - </td>
                            <td>Stealth: <span id='stealth-skill' class='value'>0</span></td>
                            <td> - </td>
                            <td>Investigation: <span id='investigation-skill' class='value'>0</span></td>
                            <td>Medicine: <span id='medicine-skill' class='value'>0</span></td>
                            <td>Performance: <span id='performance-skill' class='value'>0</span></td>
                        </tr>
                        <tr id='skills-4' class='view-row'>
                            <td> - </td>
                            <td> - </td>
                            <td> - </td>
                            <td>Nature: <span id='nature-skill' class='value'>0</span></td>
                            <td>Perception: <span id='perception-skill' class='value'>0</span></td>
                            <td>Persuasion: <span id='persuasion-skill' class='value'>0</span></td>
                        </tr>
                        <tr id='skills-5' class='view-row'>
                            <td> - </td>
                            <td> - </td>
                            <td> - </td>
                            <td>Religion: <span id='religion-skill' class='value'>0</span></td>
                            <td>Survival: <span id='survival-skill' class='value'>0</span></td>
                            <td> - </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class='block' id='char-stats'>
                <h3 style="width: 5%;text-align:center;">HP</h3>
                <input style="width: 10%; text-align: center;" id="hp-input" placeholder="0" type="number" min='0' max='9999999' value='0' key='hp'>
                <h3 style="width: 3%;text-align:center;">/</h3>
                <input style="width: 10%; text-align: center;" id="max-hp-input" placeholder="0" type="number" min='0' max='9999999' value='0' key='max_hp'>
                <h3 style="width: 5%;text-align:center;">AC</h3>
                <input style="width: 10%; text-align: center;" id="ac-input" placeholder="0" type="number" min='0' max='50' value='0' key='ac'>
                <h3 style="width: 20%;text-align:center;">Initiative</h3>
                <input style="width: 10%; text-align: center;" id="init-input" placeholder="0" type="number" value='0' min='-9999999' max='9999999' key='skills.initiative.value'>
            </div>
        </div>

        <!-- Multi-purpose selection box -->
        <div id='selection-box'></div>

        <!-- Initiative Display Box -->
        <div id='initiative-box'>
            <div id='current-init'><img id='ci-img' src="" data-tooltip=''></div>
            <div id='next-arrow'><img src="assets/next.png"></div>
            <div id='next-init'><img id='ni-img' src="" data-tooltip=''></div>
        </div>
    </body>
</html>